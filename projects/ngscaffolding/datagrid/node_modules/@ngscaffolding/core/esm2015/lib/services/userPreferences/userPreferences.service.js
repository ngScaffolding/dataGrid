import { Injectable } from '@angular/core';
import { Observable, combineLatest } from 'rxjs';
// Models
import { UserPreferenceValue, AppSettings } from '@ngscaffolding/models';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
import * as i2 from "../userAuthentication/userAuthentication.query";
import * as i3 from "../appSettings/appSettings.query";
import * as i4 from "../logging/logging.service";
import * as i5 from "./userPreferences.store";
import * as i6 from "./userPreferences.query";
import * as i7 from "../appSettings/appSettings.service";
export class UserPreferencesService {
    constructor(http, authQuery, appSettingsQuery, logger, userPrefsStore, userPrefsQuery, appSettings) {
        this.http = http;
        this.authQuery = authQuery;
        this.appSettingsQuery = appSettingsQuery;
        this.logger = logger;
        this.userPrefsStore = userPrefsStore;
        this.userPrefsQuery = userPrefsQuery;
        this.appSettings = appSettings;
        this.className = 'UserPreferencesService';
        this.prefix = 'preference_';
        this.storageKey = 'UserPreferences';
        this.valuesDownloaded = false;
        this.definitionsDownloaded = false;
        this.httpInFlight = 0;
        // Wait for settings, then load from server
        combineLatest([this.authQuery.authenticated$, this.appSettingsQuery.selectEntity(AppSettings.apiHome)]).subscribe(([authenticated, apiHome]) => {
            if (authenticated && apiHome && !this.valuesDownloaded && !this.definitionsDownloaded) {
                this.apiHome = apiHome.value;
                if (!this.httpInFlight) {
                    // Load User Prefs from Localstorage
                    this.loadFromLocal();
                    // Load Pref Defs from server
                    this.getDefinitions();
                    // Load User Prefs from Server
                    this.getValues();
                }
            }
            else if (!authenticated) {
                // Clear Here as we logoff
                this.clearValues();
            }
        });
    }
    clearValues() {
        this.userPrefsStore.remove();
        // Save to LocalStorage
        localStorage.removeItem(this.storageKey);
    }
    deleteValue(name) {
        return new Observable(observer => {
            this.http.delete(`${this.appSettings.getValue(AppSettings.apiHome)}/api/v1/userpreferencevalue/${name}`).subscribe(() => {
                // Remove and tell the world
                this.userPrefsStore.remove(name);
                localStorage.removeItem(this.storageKey);
                this.saveToLocal();
                observer.next();
                observer.complete();
            }, err => {
                observer.error(err);
            });
        });
    }
    getValues() {
        // Load values from Server
        this.httpInFlight++;
        this.http.get(`${this.appSettings.getValue(AppSettings.apiHome)}/api/v1/userpreferencevalue`).subscribe(prefValues => {
            if (prefValues) {
                prefValues.forEach(prefValue => {
                    this.userPrefsStore.upsert(prefValue.name, prefValue);
                });
                this.userPrefsStore.setLoading(false);
                this.httpInFlight--;
                this.valuesDownloaded = true;
            }
        }, err => {
            this.httpInFlight--;
            this.logger.error(err, this.className, true);
        });
    }
    setValue(key, value) {
        return new Observable(observer => {
            this.http.post(`${this.appSettings.getValue(AppSettings.apiHome)}/api/v1/userpreferencevalue`, { name: key, value: value }).subscribe(() => {
                const existingEntity = this.userPrefsQuery.getEntity(key);
                let newEntity = new UserPreferenceValue();
                if (existingEntity) {
                    newEntity = JSON.parse(JSON.stringify(existingEntity));
                }
                else {
                    newEntity.name = key;
                    newEntity.userId = this.authQuery.getValue().userDetails.userId;
                }
                newEntity.value = value;
                this.userPrefsStore.upsert(key, newEntity);
                observer.next();
                observer.complete();
            }, err => {
                observer.error(err);
            });
        });
    }
    getDefinitions() {
        this.httpInFlight++;
        this.http.get(`${this.appSettings.getValue(AppSettings.apiHome)}/api/v1/UserPreferenceDefinition`).subscribe(prefDefinitions => {
            if (prefDefinitions && prefDefinitions.length > 0) {
                let defns = [];
                prefDefinitions.forEach(definition => {
                    defns.push(definition);
                });
                this.httpInFlight--;
                this.definitionsDownloaded = true;
                this.userPrefsStore.update({ preferenceDefinitions: defns });
            }
        }, err => {
            this.httpInFlight--;
        });
    }
    loadFromLocal() {
        const stored = localStorage.getItem(this.storageKey);
        if (stored) {
            const map = JSON.parse(stored);
            if (map && map.length > 0) {
                map.forEach(value => {
                    // this.userPrefsStore.upsert(value.name, value.value);
                });
            }
        }
    }
    saveToLocal() {
        // Save to LocalStorage
        const serial = JSON.stringify(this.userPrefsQuery.getValue().entities);
        localStorage.setItem(this.storageKey, serial);
    }
}
UserPreferencesService.ɵfac = function UserPreferencesService_Factory(t) { return new (t || UserPreferencesService)(i0.ɵɵinject(i1.HttpClient), i0.ɵɵinject(i2.UserAuthenticationQuery), i0.ɵɵinject(i3.AppSettingsQuery), i0.ɵɵinject(i4.LoggingService), i0.ɵɵinject(i5.UserPreferencesStore), i0.ɵɵinject(i6.UserPreferencesQuery), i0.ɵɵinject(i7.AppSettingsService)); };
UserPreferencesService.ɵprov = i0.ɵɵdefineInjectable({ token: UserPreferencesService, factory: UserPreferencesService.ɵfac, providedIn: 'root' });
/*@__PURE__*/ (function () { i0.ɵsetClassMetadata(UserPreferencesService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: i1.HttpClient }, { type: i2.UserAuthenticationQuery }, { type: i3.AppSettingsQuery }, { type: i4.LoggingService }, { type: i5.UserPreferencesStore }, { type: i6.UserPreferencesQuery }, { type: i7.AppSettingsService }]; }, null); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXNlclByZWZlcmVuY2VzLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4vLi4vcHJvamVjdHMvbmdzY2FmZm9sZGluZy9jb3JlL3NyYy8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy91c2VyUHJlZmVyZW5jZXMvdXNlclByZWZlcmVuY2VzLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUUzQyxPQUFPLEVBQUUsVUFBVSxFQUFFLGFBQWEsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUtqRCxTQUFTO0FBQ1QsT0FBTyxFQUE0QixtQkFBbUIsRUFBRSxXQUFXLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQzs7Ozs7Ozs7O0FBU25HLE1BQU0sT0FBTyxzQkFBc0I7SUFVakMsWUFDVSxJQUFnQixFQUNoQixTQUFrQyxFQUNsQyxnQkFBa0MsRUFDbEMsTUFBc0IsRUFDdEIsY0FBb0MsRUFDcEMsY0FBb0MsRUFDcEMsV0FBK0I7UUFOL0IsU0FBSSxHQUFKLElBQUksQ0FBWTtRQUNoQixjQUFTLEdBQVQsU0FBUyxDQUF5QjtRQUNsQyxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBQ2xDLFdBQU0sR0FBTixNQUFNLENBQWdCO1FBQ3RCLG1CQUFjLEdBQWQsY0FBYyxDQUFzQjtRQUNwQyxtQkFBYyxHQUFkLGNBQWMsQ0FBc0I7UUFDcEMsZ0JBQVcsR0FBWCxXQUFXLENBQW9CO1FBaEJ4QixjQUFTLEdBQUcsd0JBQXdCLENBQUM7UUFDckMsV0FBTSxHQUFHLGFBQWEsQ0FBQztRQUN2QixlQUFVLEdBQUcsaUJBQWlCLENBQUM7UUFHeEMscUJBQWdCLEdBQUcsS0FBSyxDQUFDO1FBQ3pCLDBCQUFxQixHQUFHLEtBQUssQ0FBQztRQUM5QixpQkFBWSxHQUFHLENBQUMsQ0FBQztRQVd2QiwyQ0FBMkM7UUFDM0MsYUFBYSxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxjQUFj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RDtnQkFDekQsQ0FBQyxDQUFDLENBQUM7YUFDSjtTQUNGO0lBQ0gsQ0FBQztJQUVPLFdBQVc7UUFDakIsdUJBQXVCO1FBQ3ZCLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUV2RSxZQUFZLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDaEQsQ0FBQzs7NEZBeEpVLHNCQUFzQjs4REFBdEIsc0JBQXNCLFdBQXRCLHNCQUFzQixtQkFGckIsTUFBTTtrREFFUCxzQkFBc0I7Y0FIbEMsVUFBVTtlQUFDO2dCQUNWLFVBQVUsRUFBRSxNQUFNO2FBQ25CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBIdHRwQ2xpZW50IH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xyXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBjb21iaW5lTGF0ZXN0IH0gZnJvbSAncnhqcyc7XHJcblxyXG5pbXBvcnQgeyBVc2VyQXV0aGVudGljYXRpb25RdWVyeSB9IGZyb20gJy4uL3VzZXJBdXRoZW50aWNhdGlvbi91c2VyQXV0aGVudGljYXRpb24ucXVlcnknO1xyXG5pbXBvcnQgeyBBcHBTZXR0aW5nc1NlcnZpY2UgfSBmcm9tICcuLi9hcHBTZXR0aW5ncy9hcHBTZXR0aW5ncy5zZXJ2aWNlJztcclxuXHJcbi8vIE1vZGVsc1xyXG5pbXBvcnQgeyBVc2VyUHJlZmVyZW5jZURlZmluaXRpb24sIFVzZXJQcmVmZXJlbmNlVmFsdWUsIEFwcFNldHRpbmdzIH0gZnJvbSAnQG5nc2NhZmZvbGRpbmcvbW9kZWxzJztcclxuaW1wb3J0IHsgVXNlclByZWZlcmVuY2VzU3RvcmUgfSBmcm9tICcuL3VzZXJQcmVmZXJlbmNlcy5zdG9yZSc7XHJcbmltcG9ydCB7IFVzZXJQcmVmZXJlbmNlc1F1ZXJ5IH0gZnJvbSAnLi91c2VyUHJlZmVyZW5jZXMucXVlcnknO1xyXG5pbXBvcnQgeyBMb2dnaW5nU2VydmljZSB9IGZyb20gJy4uL2xvZ2dpbmcvbG9nZ2luZy5zZXJ2aWNlJztcclxuaW1wb3J0IHsgQXBwU2V0dGluZ3NRdWVyeSB9IGZyb20gJy4uL2FwcFNldHRpbmdzL2FwcFNldHRpbmdzLnF1ZXJ5JztcclxuXHJcbkBJbmplY3RhYmxlKHtcclxuICBwcm92aWRlZEluOiAncm9vdCdcclxufSlcclxuZXhwb3J0IGNsYXNzIFVzZXJQcmVmZXJlbmNlc1NlcnZpY2Uge1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgY2xhc3NOYW1lID0gJ1VzZXJQcmVmZXJlbmNlc1NlcnZpY2UnO1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgcHJlZml4ID0gJ3ByZWZlcmVuY2VfJztcclxuICBwcml2YXRlIHJlYWRvbmx5IHN0b3JhZ2VLZXkgPSAnVXNlclByZWZlcmVuY2VzJztcclxuXHJcbiAgcHJpdmF0ZSBhcGlIb21lOiBzdHJpbmc7XHJcbiAgcHJpdmF0ZSB2YWx1ZXNEb3dubG9hZGVkID0gZmFsc2U7XHJcbiAgcHJpdmF0ZSBkZWZpbml0aW9uc0Rvd25sb2FkZWQgPSBmYWxzZTtcclxuICBwcml2YXRlIGh0dHBJbkZsaWdodCA9IDA7XHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSBodHRwOiBIdHRwQ2xpZW50LFxyXG4gICAgcHJpdmF0ZSBhdXRoUXVlcnk6IFVzZXJBdXRoZW50aWNhdGlvblF1ZXJ5LFxyXG4gICAgcHJpdmF0ZSBhcHBTZXR0aW5nc1F1ZXJ5OiBBcHBTZXR0aW5nc1F1ZXJ5LFxyXG4gICAgcHJpdmF0ZSBsb2dnZXI6IExvZ2dpbmdTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSB1c2VyUHJlZnNTdG9yZTogVXNlclByZWZlcmVuY2VzU3RvcmUsXHJcbiAgICBwcml2YXRlIHVzZXJQcmVmc1F1ZXJ5OiBVc2VyUHJlZmVyZW5jZXNRdWVyeSxcclxuICAgIHByaXZhdGUgYXBwU2V0dGluZ3M6IEFwcFNldHRpbmdzU2VydmljZVxyXG4gICkge1xyXG4gICAgLy8gV2FpdCBmb3Igc2V0dGluZ3MsIHRoZW4gbG9hZCBmcm9tIHNlcnZlclxyXG4gICAgY29tYmluZUxhdGVzdChbdGhpcy5hdXRoUXVlcnkuYXV0aGVudGljYXRlZCQsIHRoaXMuYXBwU2V0dGluZ3NRdWVyeS5zZWxlY3RFbnRpdHkoQXBwU2V0dGluZ3MuYXBpSG9tZSldKS5zdWJzY3JpYmUoKFthdXRoZW50aWNhdGVkLCBhcGlIb21lXSkgPT4ge1xyXG4gICAgICBpZiAoYXV0aGVudGljYXRlZCAmJiBhcGlIb21lICYmICF0aGlzLnZhbHVlc0Rvd25sb2FkZWQgJiYgIXRoaXMuZGVmaW5pdGlvbnNEb3dubG9hZGVkKSB7XHJcbiAgICAgICAgdGhpcy5hcGlIb21lID0gYXBpSG9tZS52YWx1ZTtcclxuICAgICAgICBpZiAoIXRoaXMuaHR0cEluRmxpZ2h0KSB7XHJcbiAgICAgICAgICAvLyBMb2FkIFVzZXIgUHJlZnMgZnJvbSBMb2NhbHN0b3JhZ2VcclxuICAgICAgICAgIHRoaXMubG9hZEZyb21Mb2NhbCgpO1xyXG5cclxuICAgICAgICAgIC8vIExvYWQgUHJlZiBEZWZzIGZyb20gc2VydmVyXHJcbiAgICAgICAgICB0aGlzLmdldERlZmluaXRpb25zKCk7XHJcblxyXG4gICAgICAgICAgLy8gTG9hZCBVc2VyIFByZWZzIGZyb20gU2VydmVyXHJcbiAgICAgICAgICB0aGlzLmdldFZhbHVlcygpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSBlbHNlIGlmICghYXV0aGVudGljYXRlZCkge1xyXG4gICAgICAgIC8vIENsZWFyIEhlcmUgYXMgd2UgbG9nb2ZmXHJcbiAgICAgICAgdGhpcy5jbGVhclZhbHVlcygpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgY2xlYXJWYWx1ZXMoKSB7XHJcbiAgICB0aGlzLnVzZXJQcmVmc1N0b3JlLnJlbW92ZSgpO1xyXG5cclxuICAgIC8vIFNhdmUgdG8gTG9jYWxTdG9yYWdlXHJcbiAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbSh0aGlzLnN0b3JhZ2VLZXkpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGRlbGV0ZVZhbHVlKG5hbWU6IHN0cmluZykge1xyXG4gICAgcmV0dXJuIG5ldyBPYnNlcnZhYmxlPGFueT4ob2JzZXJ2ZXIgPT4ge1xyXG4gICAgICB0aGlzLmh0dHAuZGVsZXRlKGAke3RoaXMuYXBwU2V0dGluZ3MuZ2V0VmFsdWUoQXBwU2V0dGluZ3MuYXBpSG9tZSl9L2FwaS92MS91c2VycHJlZmVyZW5jZXZhbHVlLyR7bmFtZX1gKS5zdWJzY3JpYmUoXHJcbiAgICAgICAgKCkgPT4ge1xyXG4gICAgICAgICAgLy8gUmVtb3ZlIGFuZCB0ZWxsIHRoZSB3b3JsZFxyXG4gICAgICAgICAgdGhpcy51c2VyUHJlZnNTdG9yZS5yZW1vdmUobmFtZSk7XHJcblxyXG4gICAgICAgICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0odGhpcy5zdG9yYWdlS2V5KTtcclxuICAgICAgICAgIHRoaXMuc2F2ZVRvTG9jYWwoKTtcclxuXHJcbiAgICAgICAgICBvYnNlcnZlci5uZXh0KCk7XHJcbiAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZXJyID0+IHtcclxuICAgICAgICAgIG9ic2VydmVyLmVycm9yKGVycik7XHJcbiAgICAgICAgfVxyXG4gICAgICApO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgZ2V0VmFsdWVzKCkge1xyXG4gICAgLy8gTG9hZCB2YWx1ZXMgZnJvbSBTZXJ2ZXJcclxuICAgIHRoaXMuaHR0cEluRmxpZ2h0Kys7XHJcbiAgICB0aGlzLmh0dHAuZ2V0PEFycmF5PFVzZXJQcmVmZXJlbmNlVmFsdWU+PihgJHt0aGlzLmFwcFNldHRpbmdzLmdldFZhbHVlKEFwcFNldHRpbmdzLmFwaUhvbWUpfS9hcGkvdjEvdXNlcnByZWZlcmVuY2V2YWx1ZWApLnN1YnNjcmliZShcclxuICAgICAgcHJlZlZhbHVlcyA9PiB7XHJcbiAgICAgICAgaWYgKHByZWZWYWx1ZXMpIHtcclxuICAgICAgICAgIHByZWZWYWx1ZXMuZm9yRWFjaChwcmVmVmFsdWUgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLnVzZXJQcmVmc1N0b3JlLnVwc2VydChwcmVmVmFsdWUubmFtZSwgcHJlZlZhbHVlKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgdGhpcy51c2VyUHJlZnNTdG9yZS5zZXRMb2FkaW5nKGZhbHNlKTtcclxuICAgICAgICAgIHRoaXMuaHR0cEluRmxpZ2h0LS07XHJcbiAgICAgICAgICB0aGlzLnZhbHVlc0Rvd25sb2FkZWQgPSB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgfSxcclxuICAgICAgZXJyID0+IHtcclxuICAgICAgICB0aGlzLmh0dHBJbkZsaWdodC0tO1xyXG4gICAgICAgIHRoaXMubG9nZ2VyLmVycm9yKGVyciwgdGhpcy5jbGFzc05hbWUsIHRydWUpO1xyXG4gICAgICB9XHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHNldFZhbHVlKGtleTogc3RyaW5nLCB2YWx1ZTogYW55KTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIHJldHVybiBuZXcgT2JzZXJ2YWJsZTxhbnk+KG9ic2VydmVyID0+IHtcclxuICAgICAgdGhpcy5odHRwLnBvc3QoYCR7dGhpcy5hcHBTZXR0aW5ncy5nZXRWYWx1ZShBcHBTZXR0aW5ncy5hcGlIb21lKX0vYXBpL3YxL3VzZXJwcmVmZXJlbmNldmFsdWVgLCB7IG5hbWU6IGtleSwgdmFsdWU6IHZhbHVlIH0pLnN1YnNjcmliZShcclxuICAgICAgICAoKSA9PiB7XHJcbiAgICAgICAgICBjb25zdCBleGlzdGluZ0VudGl0eSA9IHRoaXMudXNlclByZWZzUXVlcnkuZ2V0RW50aXR5KGtleSk7XHJcbiAgICAgICAgICBsZXQgbmV3RW50aXR5ID0gbmV3IFVzZXJQcmVmZXJlbmNlVmFsdWUoKTtcclxuXHJcbiAgICAgICAgICBpZiAoZXhpc3RpbmdFbnRpdHkpIHtcclxuICAgICAgICAgICAgbmV3RW50aXR5ID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShleGlzdGluZ0VudGl0eSkpO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgbmV3RW50aXR5Lm5hbWUgPSBrZXk7XHJcbiAgICAgICAgICAgIG5ld0VudGl0eS51c2VySWQgPSB0aGlzLmF1dGhRdWVyeS5nZXRWYWx1ZSgpLnVzZXJEZXRhaWxzLnVzZXJJZDtcclxuICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICBuZXdFbnRpdHkudmFsdWUgPSB2YWx1ZTtcclxuICAgICAgICAgIHRoaXMudXNlclByZWZzU3RvcmUudXBzZXJ0KGtleSwgbmV3RW50aXR5KTtcclxuXHJcbiAgICAgICAgICBvYnNlcnZlci5uZXh0KCk7XHJcbiAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZXJyID0+IHtcclxuICAgICAgICAgIG9ic2VydmVyLmVycm9yKGVycik7XHJcbiAgICAgICAgfVxyXG4gICAgICApO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGdldERlZmluaXRpb25zKCkge1xyXG4gICAgdGhpcy5odHRwSW5GbGlnaHQrKztcclxuICAgIHRoaXMuaHR0cC5nZXQ8QXJyYXk8VXNlclByZWZlcmVuY2VEZWZpbml0aW9uPj4oYCR7dGhpcy5hcHBTZXR0aW5ncy5nZXRWYWx1ZShBcHBTZXR0aW5ncy5hcGlIb21lKX0vYXBpL3YxL1VzZXJQcmVmZXJlbmNlRGVmaW5pdGlvbmApLnN1YnNjcmliZShcclxuICAgICAgcHJlZkRlZmluaXRpb25zID0+IHtcclxuICAgICAgICBpZiAocHJlZkRlZmluaXRpb25zICYmIHByZWZEZWZpbml0aW9ucy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICBsZXQgZGVmbnMgPSBbXTtcclxuICAgICAgICAgIHByZWZEZWZpbml0aW9ucy5mb3JFYWNoKGRlZmluaXRpb24gPT4ge1xyXG4gICAgICAgICAgICBkZWZucy5wdXNoKGRlZmluaXRpb24pO1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgICB0aGlzLmh0dHBJbkZsaWdodC0tO1xyXG4gICAgICAgICAgdGhpcy5kZWZpbml0aW9uc0Rvd25sb2FkZWQgPSB0cnVlO1xyXG4gICAgICAgICAgdGhpcy51c2VyUHJlZnNTdG9yZS51cGRhdGUoeyBwcmVmZXJlbmNlRGVmaW5pdGlvbnM6IGRlZm5zIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgfSxcclxuICAgICAgZXJyID0+IHtcclxuICAgICAgICB0aGlzLmh0dHBJbkZsaWdodC0tO1xyXG4gICAgICB9XHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBsb2FkRnJvbUxvY2FsKCkge1xyXG4gICAgY29uc3Qgc3RvcmVkID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0odGhpcy5zdG9yYWdlS2V5KTtcclxuICAgIGlmIChzdG9yZWQpIHtcclxuICAgICAgY29uc3QgbWFwOiBBcnJheTxVc2VyUHJlZmVyZW5jZVZhbHVlPiA9IEpTT04ucGFyc2Uoc3RvcmVkKTtcclxuICAgICAgaWYgKG1hcCAmJiBtYXAubGVuZ3RoID4gMCkge1xyXG4gICAgICAgIG1hcC5mb3JFYWNoKHZhbHVlID0+IHtcclxuICAgICAgICAgIC8vIHRoaXMudXNlclByZWZzU3RvcmUudXBzZXJ0KHZhbHVlLm5hbWUsIHZhbHVlLnZhbHVlKTtcclxuICAgICAgICB9KTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzYXZlVG9Mb2NhbCgpOiB2b2lkIHtcclxuICAgIC8vIFNhdmUgdG8gTG9jYWxTdG9yYWdlXHJcbiAgICBjb25zdCBzZXJpYWwgPSBKU09OLnN0cmluZ2lmeSh0aGlzLnVzZXJQcmVmc1F1ZXJ5LmdldFZhbHVlKCkuZW50aXRpZXMpO1xyXG5cclxuICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKHRoaXMuc3RvcmFnZUtleSwgc2VyaWFsKTtcclxuICB9XHJcbn1cclxuIl19