import { Observable, of } from 'rxjs';
import { retry, timeout } from 'rxjs/operators';
import { Injectable } from '@angular/core';
import { AppSettings, } from '@ngscaffolding/models';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
import * as i2 from "./dataSource.store";
import * as i3 from "./dataSource.query";
import * as i4 from "../appSettings/appSettings.service";
import * as i5 from "../appAudit/appAudit.service";
import * as i6 from "../logging/logging.service";
export class DataSourceService {
    constructor(http, dataSourceStore, dataSourceQuery, appSettingsService, appAuditService, logger) {
        this.http = http;
        this.dataSourceStore = dataSourceStore;
        this.dataSourceQuery = dataSourceQuery;
        this.appSettingsService = appSettingsService;
        this.appAuditService = appAuditService;
        this.logger = logger;
        this.className = 'DataSourceService';
        this.inflightRequests = new Map();
    }
    decorateInput(inputDetails) {
        return null;
    }
    getDataSource(dataRequest) {
        const key = this.getKey(dataRequest);
        if (dataRequest.forceRefresh) {
            this.dataSourceStore.remove(key);
        }
        const currentCacheValue = this.dataSourceQuery.getEntity(key);
        if (currentCacheValue) {
            if (currentCacheValue.expiresWhen > new Date()) {
                // Return good cached value
                return of(currentCacheValue);
            }
            else {
                // Expired - Bad cache
                this.dataSourceStore.remove(key);
            }
        }
        if (this.inflightRequests.has(key)) {
            return this.inflightRequests.get(key);
        }
        // Make HTTP Request
        const formData = new FormData();
        formData.append('dataSourceRequest', JSON.stringify(dataRequest));
        // Add Files if passed
        if (dataRequest.fileNames) {
            let fileCount = 0;
            dataRequest.fileNames.forEach((file) => {
                formData.append(`file-${fileCount++}`, file, file.name);
            });
        }
        const logEntry = {
            entity: 'DataSource Call',
            action: key,
            values: {
                filterValues: dataRequest.filterValues,
                inputData: dataRequest.inputData,
            },
        };
        this.logger.info(`Calling Datasource ${dataRequest.name}`, null, logEntry.values);
        this.inflightRequests.set(key, new Observable((observer) => {
            this.http
                .post(`${this.appSettingsService.getValue(AppSettings.apiHome)}/api/v1/datasource`, formData)
                .pipe(timeout(20000), retry(3))
                .subscribe((values) => {
                const expiryNow = new Date();
                // If expires Seconds not provided set long expiry
                const expiresSeconds = values.expiresSeconds > 0 ? values.expiresSeconds : 99999999;
                const expiresWhen = new Date(expiryNow.getTime() + expiresSeconds * 10000);
                const newResults = {
                    expiresWhen: expiresWhen,
                    rowCount: values.rowCount,
                    jsonData: values.jsonData,
                    results: values.results,
                };
                // Log Datasource Success
                this.appAuditService.RecordLog(Object.assign(Object.assign({}, logEntry), { result: 'Success' }));
                // Update the Store to tell the world we have data
                this.dataSourceStore.update(key, newResults);
                this.inflightRequests.delete(key);
                observer.next(newResults);
                observer.complete();
            }, (err) => {
                // Update the Store to tell the world we failed in every way. Shame.
                const errorResults = {
                    expiresWhen: new Date(),
                    error: err.message,
                };
                // Log Datasource Success
                this.appAuditService.RecordLog(Object.assign(Object.assign({}, logEntry), { result: err.message }));
                this.dataSourceStore.update(key, errorResults);
                this.inflightRequests.delete(key);
                this.logger.error(err, 'DataSource.Service.getDataSource', false);
                observer.error(err);
            });
        }));
        return this.inflightRequests.get(key);
    }
    getKey(dataRequest) {
        return `name:${dataRequest.name} seed:${dataRequest.seed} inputData:${JSON.stringify(dataRequest.inputData)} `;
    }
}
DataSourceService.ɵfac = function DataSourceService_Factory(t) { return new (t || DataSourceService)(i0.ɵɵinject(i1.HttpClient), i0.ɵɵinject(i2.DataSourceStore), i0.ɵɵinject(i3.DataSourceQuery), i0.ɵɵinject(i4.AppSettingsService), i0.ɵɵinject(i5.AppAuditService), i0.ɵɵinject(i6.LoggingService)); };
DataSourceService.ɵprov = i0.ɵɵdefineInjectable({ token: DataSourceService, factory: DataSourceService.ɵfac, providedIn: 'root' });
/*@__PURE__*/ (function () { i0.ɵsetClassMetadata(DataSourceService, [{
        type: Injectable,
        args: [{
                providedIn: 'root',
            }]
    }], function () { return [{ type: i1.HttpClient }, { type: i2.DataSourceStore }, { type: i3.DataSourceQuery }, { type: i4.AppSettingsService }, { type: i5.AppAuditService }, { type: i6.LoggingService }]; }, null); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YVNvdXJjZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uLy4uL3Byb2plY3RzL25nc2NhZmZvbGRpbmcvY29yZS9zcmMvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvZGF0YVNvdXJjZS9kYXRhU291cmNlLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBd0IsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzVELE9BQU8sRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFaEQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUczQyxPQUFPLEVBR0wsV0FBVyxHQUVaLE1BQU0sdUJBQXVCLENBQUM7Ozs7Ozs7O0FBUy9CLE1BQU0sT0FBTyxpQkFBaUI7SUFJNUIsWUFDVSxJQUFnQixFQUNoQixlQUFnQyxFQUNoQyxlQUFnQyxFQUNoQyxrQkFBc0MsRUFDdEMsZUFBZ0MsRUFDaEMsTUFBc0I7UUFMdEIsU0FBSSxHQUFKLElBQUksQ0FBWTtRQUNoQixvQkFBZSxHQUFmLGVBQWUsQ0FBaUI7UUFDaEMsb0JBQWUsR0FBZixlQUFlLENBQWlCO1FBQ2hDLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7UUFDdEMsb0JBQWUsR0FBZixlQUFlLENBQWlCO1FBQ2hDLFdBQU0sR0FBTixNQUFNLENBQWdCO1FBVHhCLGNBQVMsR0FBRyxtQkFBbUIsQ0FBQztRQUNoQyxxQkFBZ0IsR0FBRyxJQUFJLEdBQUcsRUFBbUMsQ0FBQztJQVNuRSxDQUFDO0lBRUosYUFBYSxDQUFDLFlBQW9CO1FBQ2hDLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUVELGFBQWEsQ0FBQyxXQUE4QjtRQUMxQyxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBRXJDLElBQUksV0FBVyxDQUFDLFlBQVksRUFBRTtZQUM1QixJQUFJ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M0MsT0FBTyxRQUFRLFdBQVcsQ0FBQyxJQUFJLFNBQzdCLFdBQVcsQ0FBQyxJQUNkLGNBQWMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQztJQUN6RCxDQUFDOztrRkF4SVUsaUJBQWlCO3lEQUFqQixpQkFBaUIsV0FBakIsaUJBQWlCLG1CQUZoQixNQUFNO2tEQUVQLGlCQUFpQjtjQUg3QixVQUFVO2VBQUM7Z0JBQ1YsVUFBVSxFQUFFLE1BQU07YUFDbkIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBPYnNlcnZhYmxlLCBmb3JrSm9pbiwgdGhyb3dFcnJvciwgb2YgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgcmV0cnksIHRpbWVvdXQgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IEh0dHBDbGllbnQgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XHJcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuXHJcbmltcG9ydCB7IEFwcFNldHRpbmdzU2VydmljZSB9IGZyb20gJy4uL2FwcFNldHRpbmdzL2FwcFNldHRpbmdzLnNlcnZpY2UnO1xyXG5pbXBvcnQge1xyXG4gIERhdGFTb3VyY2VSZXF1ZXN0LFxyXG4gIERhdGFSZXN1bHRzLFxyXG4gIEFwcFNldHRpbmdzLFxyXG4gIEFwcGxpY2F0aW9uTG9nLFxyXG59IGZyb20gJ0BuZ3NjYWZmb2xkaW5nL21vZGVscyc7XHJcbmltcG9ydCB7IExvZ2dpbmdTZXJ2aWNlIH0gZnJvbSAnLi4vbG9nZ2luZy9sb2dnaW5nLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBEYXRhU291cmNlU3RvcmUgfSBmcm9tICcuL2RhdGFTb3VyY2Uuc3RvcmUnO1xyXG5pbXBvcnQgeyBEYXRhU291cmNlUXVlcnkgfSBmcm9tICcuL2RhdGFTb3VyY2UucXVlcnknO1xyXG5pbXBvcnQgeyBBcHBBdWRpdFNlcnZpY2UgfSBmcm9tICcuLi9hcHBBdWRpdC9hcHBBdWRpdC5zZXJ2aWNlJztcclxuXHJcbkBJbmplY3RhYmxlKHtcclxuICBwcm92aWRlZEluOiAncm9vdCcsXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBEYXRhU291cmNlU2VydmljZSB7XHJcbiAgcHJpdmF0ZSBjbGFzc05hbWUgPSAnRGF0YVNvdXJjZVNlcnZpY2UnO1xyXG4gIHByaXZhdGUgaW5mbGlnaHRSZXF1ZXN0cyA9IG5ldyBNYXA8c3RyaW5nLCBPYnNlcnZhYmxlPERhdGFSZXN1bHRzPj4oKTtcclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIGh0dHA6IEh0dHBDbGllbnQsXHJcbiAgICBwcml2YXRlIGRhdGFTb3VyY2VTdG9yZTogRGF0YVNvdXJjZVN0b3JlLFxyXG4gICAgcHJpdmF0ZSBkYXRhU291cmNlUXVlcnk6IERhdGFTb3VyY2VRdWVyeSxcclxuICAgIHByaXZhdGUgYXBwU2V0dGluZ3NTZXJ2aWNlOiBBcHBTZXR0aW5nc1NlcnZpY2UsXHJcbiAgICBwcml2YXRlIGFwcEF1ZGl0U2VydmljZTogQXBwQXVkaXRTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBsb2dnZXI6IExvZ2dpbmdTZXJ2aWNlXHJcbiAgKSB7fVxyXG5cclxuICBkZWNvcmF0ZUlucHV0KGlucHV0RGV0YWlsczogb2JqZWN0KTogb2JqZWN0IHtcclxuICAgIHJldHVybiBudWxsO1xyXG4gIH1cclxuXHJcbiAgZ2V0RGF0YVNvdXJjZShkYXRhUmVxdWVzdDogRGF0YVNvdXJjZVJlcXVlc3QpOiBPYnNlcnZhYmxlPERhdGFSZXN1bHRzPiB7XHJcbiAgICBjb25zdCBrZXkgPSB0aGlzLmdldEtleShkYXRhUmVxdWVzdCk7XHJcblxyXG4gICAgaWYgKGRhdGFSZXF1ZXN0LmZvcmNlUmVmcmVzaCkge1xyXG4gICAgICB0aGlzLmRhdGFTb3VyY2VTdG9yZS5yZW1vdmUoa2V5KTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBjdXJyZW50Q2FjaGVWYWx1ZSA9IHRoaXMuZGF0YVNvdXJjZVF1ZXJ5LmdldEVudGl0eShrZXkpO1xyXG4gICAgaWYgKGN1cnJlbnRDYWNoZVZhbHVlKSB7XHJcbiAgICAgIGlmIChjdXJyZW50Q2FjaGVWYWx1ZS5leHBpcmVzV2hlbiA+IG5ldyBEYXRlKCkpIHtcclxuICAgICAgICAvLyBSZXR1cm4gZ29vZCBjYWNoZWQgdmFsdWVcclxuICAgICAgICByZXR1cm4gb2YoY3VycmVudENhY2hlVmFsdWUpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIC8vIEV4cGlyZWQgLSBCYWQgY2FjaGVcclxuICAgICAgICB0aGlzLmRhdGFTb3VyY2VTdG9yZS5yZW1vdmUoa2V5KTtcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGlmICh0aGlzLmluZmxpZ2h0UmVxdWVzdHMuaGFzKGtleSkpIHtcclxuICAgICAgcmV0dXJuIHRoaXMuaW5mbGlnaHRSZXF1ZXN0cy5nZXQoa2V5KTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBNYWtlIEhUVFAgUmVxdWVzdFxyXG4gICAgY29uc3QgZm9ybURhdGE6IEZvcm1EYXRhID0gbmV3IEZvcm1EYXRhKCk7XHJcbiAgICBmb3JtRGF0YS5hcHBlbmQoJ2RhdGFTb3VyY2VSZXF1ZXN0JywgSlNPTi5zdHJpbmdpZnkoZGF0YVJlcXVlc3QpKTtcclxuXHJcbiAgICAvLyBBZGQgRmlsZXMgaWYgcGFzc2VkXHJcbiAgICBpZiAoZGF0YVJlcXVlc3QuZmlsZU5hbWVzKSB7XHJcbiAgICAgIGxldCBmaWxlQ291bnQgPSAwO1xyXG4gICAgICBkYXRhUmVxdWVzdC5maWxlTmFtZXMuZm9yRWFjaCgoZmlsZSkgPT4ge1xyXG4gICAgICAgIGZvcm1EYXRhLmFwcGVuZChgZmlsZS0ke2ZpbGVDb3VudCsrfWAsIGZpbGUsIGZpbGUubmFtZSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGxvZ0VudHJ5OiBBcHBsaWNhdGlvbkxvZyA9IHtcclxuICAgICAgZW50aXR5OiAnRGF0YVNvdXJjZSBDYWxsJyxcclxuICAgICAgYWN0aW9uOiBrZXksXHJcbiAgICAgIHZhbHVlczoge1xyXG4gICAgICAgIGZpbHRlclZhbHVlczogZGF0YVJlcXVlc3QuZmlsdGVyVmFsdWVzLFxyXG4gICAgICAgIGlucHV0RGF0YTogZGF0YVJlcXVlc3QuaW5wdXREYXRhLFxyXG4gICAgICB9LFxyXG4gICAgfTtcclxuXHJcbiAgICB0aGlzLmxvZ2dlci5pbmZvKFxyXG4gICAgICBgQ2FsbGluZyBEYXRhc291cmNlICR7ZGF0YVJlcXVlc3QubmFtZX1gLFxyXG4gICAgICBudWxsLFxyXG4gICAgICBsb2dFbnRyeS52YWx1ZXNcclxuICAgICk7XHJcblxyXG4gICAgdGhpcy5pbmZsaWdodFJlcXVlc3RzLnNldChcclxuICAgICAga2V5LFxyXG4gICAgICBuZXcgT2JzZXJ2YWJsZTxEYXRhUmVzdWx0cz4oKG9ic2VydmVyKSA9PiB7XHJcbiAgICAgICAgdGhpcy5odHRwXHJcbiAgICAgICAgICAucG9zdDxEYXRhUmVzdWx0cz4oXHJcbiAgICAgICAgICAgIGAke3RoaXMuYXBwU2V0dGluZ3NTZXJ2aWNlLmdldFZhbHVlKFxyXG4gICAgICAgICAgICAgIEFwcFNldHRpbmdzLmFwaUhvbWVcclxuICAgICAgICAgICAgKX0vYXBpL3YxL2RhdGFzb3VyY2VgLFxyXG4gICAgICAgICAgICBmb3JtRGF0YVxyXG4gICAgICAgICAgKVxyXG4gICAgICAgICAgLnBpcGUodGltZW91dCgyMDAwMCksIHJldHJ5KDMpKVxyXG4gICAgICAgICAgLnN1YnNjcmliZShcclxuICAgICAgICAgICAgKHZhbHVlcykgPT4ge1xyXG4gICAgICAgICAgICAgIGNvbnN0IGV4cGlyeU5vdyA9IG5ldyBEYXRlKCk7XHJcblxyXG4gICAgICAgICAgICAgIC8vIElmIGV4cGlyZXMgU2Vjb25kcyBub3QgcHJvdmlkZWQgc2V0IGxvbmcgZXhwaXJ5XHJcbiAgICAgICAgICAgICAgY29uc3QgZXhwaXJlc1NlY29uZHMgPVxyXG4gICAgICAgICAgICAgICAgdmFsdWVzLmV4cGlyZXNTZWNvbmRzID4gMCA/IHZhbHVlcy5leHBpcmVzU2Vjb25kcyA6IDk5OTk5OTk5O1xyXG4gICAgICAgICAgICAgIGNvbnN0IGV4cGlyZXNXaGVuID0gbmV3IERhdGUoXHJcbiAgICAgICAgICAgICAgICBleHBpcnlOb3cuZ2V0VGltZSgpICsgZXhwaXJlc1NlY29uZHMgKiAxMDAwMFxyXG4gICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgY29uc3QgbmV3UmVzdWx0czogRGF0YVJlc3VsdHMgPSB7XHJcbiAgICAgICAgICAgICAgICBleHBpcmVzV2hlbjogZXhwaXJlc1doZW4sXHJcbiAgICAgICAgICAgICAgICByb3dDb3VudDogdmFsdWVzLnJvd0NvdW50LFxyXG4gICAgICAgICAgICAgICAganNvbkRhdGE6IHZhbHVlcy5qc29uRGF0YSxcclxuICAgICAgICAgICAgICAgIHJlc3VsdHM6IHZhbHVlcy5yZXN1bHRzLFxyXG4gICAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICAgIC8vIExvZyBEYXRhc291cmNlIFN1Y2Nlc3NcclxuICAgICAgICAgICAgICB0aGlzLmFwcEF1ZGl0U2VydmljZS5SZWNvcmRMb2coe1xyXG4gICAgICAgICAgICAgICAgLi4ubG9nRW50cnksXHJcbiAgICAgICAgICAgICAgICByZXN1bHQ6ICdTdWNjZXNzJyxcclxuICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgLy8gVXBkYXRlIHRoZSBTdG9yZSB0byB0ZWxsIHRoZSB3b3JsZCB3ZSBoYXZlIGRhdGFcclxuICAgICAgICAgICAgICB0aGlzLmRhdGFTb3VyY2VTdG9yZS51cGRhdGUoa2V5LCBuZXdSZXN1bHRzKTtcclxuICAgICAgICAgICAgICB0aGlzLmluZmxpZ2h0UmVxdWVzdHMuZGVsZXRlKGtleSk7XHJcbiAgICAgICAgICAgICAgb2JzZXJ2ZXIubmV4dChuZXdSZXN1bHRzKTtcclxuICAgICAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgICAgLy8gVXBkYXRlIHRoZSBTdG9yZSB0byB0ZWxsIHRoZSB3b3JsZCB3ZSBmYWlsZWQgaW4gZXZlcnkgd2F5LiBTaGFtZS5cclxuICAgICAgICAgICAgICBjb25zdCBlcnJvclJlc3VsdHM6IERhdGFSZXN1bHRzID0ge1xyXG4gICAgICAgICAgICAgICAgZXhwaXJlc1doZW46IG5ldyBEYXRlKCksXHJcbiAgICAgICAgICAgICAgICBlcnJvcjogZXJyLm1lc3NhZ2UsXHJcbiAgICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgICAgLy8gTG9nIERhdGFzb3VyY2UgU3VjY2Vzc1xyXG4gICAgICAgICAgICAgIHRoaXMuYXBwQXVkaXRTZXJ2aWNlLlJlY29yZExvZyh7XHJcbiAgICAgICAgICAgICAgICAuLi5sb2dFbnRyeSxcclxuICAgICAgICAgICAgICAgIHJlc3VsdDogZXJyLm1lc3NhZ2UsXHJcbiAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgIHRoaXMuZGF0YVNvdXJjZVN0b3JlLnVwZGF0ZShrZXksIGVycm9yUmVzdWx0cyk7XHJcbiAgICAgICAgICAgICAgdGhpcy5pbmZsaWdodFJlcXVlc3RzLmRlbGV0ZShrZXkpO1xyXG5cclxuICAgICAgICAgICAgICB0aGlzLmxvZ2dlci5lcnJvcihlcnIsICdEYXRhU291cmNlLlNlcnZpY2UuZ2V0RGF0YVNvdXJjZScsIGZhbHNlKTtcclxuICAgICAgICAgICAgICBvYnNlcnZlci5lcnJvcihlcnIpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICApO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuXHJcbiAgICByZXR1cm4gdGhpcy5pbmZsaWdodFJlcXVlc3RzLmdldChrZXkpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXRLZXkoZGF0YVJlcXVlc3Q6IERhdGFTb3VyY2VSZXF1ZXN0KSB7XHJcbiAgICByZXR1cm4gYG5hbWU6JHtkYXRhUmVxdWVzdC5uYW1lfSBzZWVkOiR7XHJcbiAgICAgIGRhdGFSZXF1ZXN0LnNlZWRcclxuICAgIH0gaW5wdXREYXRhOiR7SlNPTi5zdHJpbmdpZnkoZGF0YVJlcXVlc3QuaW5wdXREYXRhKX0gYDtcclxuICB9XHJcbn1cclxuIl19