import { Injectable } from '@angular/core';
import { BehaviorSubject, combineLatest, Observable } from 'rxjs';
import { timeout, finalize } from 'rxjs/operators';
import { AppSettings } from '@ngscaffolding/models';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
import * as i2 from "./menu.store";
import * as i3 from "./menu.query";
import * as i4 from "../appSettings/appSettings.query";
import * as i5 from "../userAuthentication/userAuthentication.query";
import * as i6 from "../logging/logging.service";
import * as i7 from "../rolesService/roles.service";
export class MenuService {
    constructor(http, menuStore, menuQuery, appSettingsQuery, authQuery, log, rolesService) {
        this.http = http;
        this.menuStore = menuStore;
        this.menuQuery = menuQuery;
        this.appSettingsQuery = appSettingsQuery;
        this.authQuery = authQuery;
        this.log = log;
        this.rolesService = rolesService;
        this.methodName = 'MenuService';
        this.masterListMenu = [];
        this.routes = [];
        this.menuItems = [];
        this.routeSubject = new BehaviorSubject(this.routes);
        this.httpInFlight = false;
        this.lockCount = 0;
        this.menuDownloaded = false;
        // Wait for settings, then load from server
        combineLatest([
            this.authQuery.authenticated$,
            this.appSettingsQuery.selectEntity(AppSettings.apiHome),
            this.appSettingsQuery.selectEntity(AppSettings.isMobile)
        ]).subscribe(([authenticated, apiHome, isMobile]) => {
            if (authenticated && apiHome && isMobile && !this.menuDownloaded) {
                this.apiHome = apiHome.value;
                if (!this.httpInFlight) {
                    this.downloadMenuItems(isMobile.value || false);
                }
            }
            else if (!authenticated) {
                this.menuDownloaded = false;
                this.lockCount = 0;
            }
        });
    }
    addLock() {
        this.lockCount++;
        this.log.info(`MENU Service: Locks on Loading`, this.methodName, this.lockCount);
        this.menuStore.setLoading(true);
    }
    setCurrent(name) {
        this.menuStore.setActive(name);
    }
    removeLock() {
        this.lockCount--;
        this.log.info(`MENU Service: Locks on Loading`, this.methodName, this.lockCount);
        if (this.lockCount === 0) {
            this.menuStore.setLoading(false);
        }
    }
    addMenuItemsFromCode(menuItems, roles = null) {
        this.addLock();
        this.log.info('Adding MenuItems menuItems', this.methodName, menuItems);
        // Wait till user authorised
        this.authQuery.authenticated$.subscribe(authorised => {
            if (authorised) {
                // Save for later use
                this.addMenuItems(menuItems);
                this.removeLock();
            }
        });
    }
    getFolders() {
        return this.menuQuery.getAll({
            filterBy: [entity => entity.type === "folder" /* Folder */]
        });
    }
    delete(menuItem) {
        return new Observable(observer => {
            const obs = this.http.delete(`${this.apiHome}/api/v1/menuitems/${menuItem.name}`);
            obs.subscribe(() => {
                // Remove from our store
                this.menuStore.remove(menuItem.name);
                // Remove from Tree
                const existingMenus = JSON.parse(JSON.stringify(this.menuQuery.getValue())).menuItems;
                let parentMenu;
                if (menuItem.parent) {
                    parentMenu = existingMenus.find(menu => menu.name && menu.name.toLowerCase() === menuItem.parent.toLowerCase());
                }
                const foundIndex = parentMenu.items.findIndex(childMenu => childMenu.name && childMenu.name === menuItem.name);
                parentMenu.items.splice(foundIndex, 1);
                // Update tree and tell the world
                this.menuStore.update({ menuItems: existingMenus });
                observer.next();
                observer.complete();
            }, err => {
                observer.error(err);
            });
        });
    }
    saveMenuItem(menuItem) {
        return this.http.post(this.apiHome + '/api/v1/menuitems', menuItem);
    }
    updateExistingMenuItem(menuItem) {
        // Is this existing?
        const existing = this.menuQuery.hasEntity(menuItem.name);
        if (existing) {
            this.menuStore.upsert(menuItem.name, menuItem);
        }
        else {
            // Add to reference list of menus
            this.menuStore.add(menuItem);
        }
        const existingMenus = JSON.parse(JSON.stringify(this.menuQuery.getAll()));
        let parentMenu;
        if (menuItem.parent) {
            parentMenu = existingMenus.find(menu => menu.name.toLowerCase() === menuItem.parent.toLowerCase());
        }
        // Add to treeview for menu rendering
        if (!parentMenu.items || !Array.isArray(parentMenu.items)) {
            parentMenu.items = [];
        }
        if (existing) {
            const foundIndex = parentMenu.items.findIndex(childMenu => childMenu.name === menuItem.name);
            parentMenu.items[foundIndex] = menuItem;
        }
        else {
            parentMenu.items.push(menuItem);
        }
        // Update tree and tell the world
        this.menuStore.update({ menuItems: existingMenus });
    }
    // Iterative Call
    addMenuItemsToReferenceList(menuItems) {
        menuItems.forEach(menuItem => {
            // Add to Entity Store
            this.menuStore.upsert(menuItem.name, menuItem);
            if (menuItem.items && Array.isArray(menuItem.items)) {
                this.addMenuItemsToReferenceList(menuItem.items);
            }
        });
    }
    removeUnauthorisedMenuItems(menuItems) {
        const user = this.authQuery.getValue();
        let userRoles = [];
        if (user && user.userDetails) {
            userRoles = user.userDetails.role;
        }
        const removingMenus = [];
        let returnMenus = JSON.parse(JSON.stringify(menuItems));
        for (let menuIndex = 0; menuIndex < returnMenus.length; menuIndex++) {
            const menuItem = returnMenus[menuIndex];
            let removingThis = false;
            // makes sure roles is array
            let checkingRoles = [];
            if (!menuItem.roles) {
                checkingRoles = [];
            }
            else if (Array.isArray(menuItem.roles)) {
                checkingRoles = [...menuItem.roles];
            }
            else {
                checkingRoles = [menuItem.roles];
            }
            // Is this role protected
            if (checkingRoles && checkingRoles.length > 0) {
                if (userRoles && checkingRoles.filter(allowedRole => userRoles.indexOf(allowedRole) !== -1).length === 0) {
                    // No Authority. Remove
                    removingThis = true;
                    removingMenus.push(menuItem.name);
                }
            }
            if (!removingThis && menuItem.items) {
                menuItem.items = this.removeUnauthorisedMenuItems(menuItem.items);
            }
        }
        if (removingMenus.length > 0) {
            returnMenus = menuItems.filter(menu => removingMenus.findIndex(remove => remove === menu.name) === -1);
        }
        return returnMenus;
    }
    downloadMenuItems(isMobile) {
        // Mark loading status
        this.addLock();
        this.httpInFlight = true;
        const newMenuItems = [];
        this.http
            .get(`${this.apiHome}/api/v1/menuitems?mobile=${isMobile}`)
            .pipe(timeout(60000), finalize(() => {
            this.httpInFlight = false;
            this.removeLock();
        }))
            .subscribe(downloadedMenuItems => {
            this.log.info(`Downloaded MenuItems`);
            this.menuDownloaded = true;
            this.addMenuItems(downloadedMenuItems);
        }, err => {
            this.log.error('Failed to download Menu');
        });
    }
    addMenuItems(newMenuItems, findInTree = false) {
        // Clone so we can amend
        const fetchedMenuItems = this.menuQuery.getValue().menuItems || [];
        this.menuItems = JSON.parse(JSON.stringify(fetchedMenuItems));
        this.calculateRouterLinks(newMenuItems);
        // Add to flat reference List
        this.addMenuItemsToReferenceList(newMenuItems);
        if (findInTree) {
            newMenuItems.forEach(loopMenuItem => {
                this.upsertMenuItemToExistingTree(loopMenuItem);
            });
        }
        else {
            newMenuItems.forEach(loopMenuItem => {
                this.addNewMenuItemToEntities(this.menuItems, loopMenuItem);
            });
        }
        // Remove the unatuhorised
        this.menuItems = this.removeUnauthorisedMenuItems(this.menuItems);
        this.menuStore.update({ menuItems: this.menuItems });
    }
    calculateRouterLinks(menuItems) {
        if (menuItems) {
            menuItems.forEach(menuItem => {
                if (!menuItem.routerLink) {
                    // Need to create our routerLink
                    switch (menuItem.type) {
                        case "dashboard" /* Dashboard */: {
                            menuItem.routerLink = `dashboard/${menuItem.name}`;
                            break;
                        }
                        case "datagrid" /* Datagrid */: {
                            menuItem.routerLink = `datagrid/${menuItem.name}`;
                            break;
                        }
                        case "folder" /* Folder */: {
                            // No router link here
                            break;
                        }
                        default: {
                            menuItem.routerLink = menuItem.name;
                        }
                    }
                }
                if (menuItem.items) {
                    this.calculateRouterLinks(menuItem.items);
                }
            });
        }
    }
    addRoute(route, roles = null) {
        this.log.info(`Adding Route ${JSON.stringify(route)}`);
        this.routes.push(route);
        if (roles !== null) {
            this.rolesService.addRouteRoles(route.path, roles);
        }
    }
    upsertMenuItemToExistingTree(newMenuItem) {
        const menuItems = [...this.menuItems];
        if (!newMenuItem.parent || newMenuItem.parent === '') {
            // Root menu item
            let existing = menuItems.find(menu => menu.name === newMenuItem.name);
            if (existing) {
                existing = Object.assign({}, newMenuItem);
            }
            else {
                menuItems.push(Object.assign({}, newMenuItem));
            }
        }
        else {
            // Submenu item
            const parent = menuItems.find(menu => menu.name === newMenuItem.parent);
            if (parent) {
                let existing = parent.items.find(menu => menu.name === newMenuItem.name);
                if (existing) {
                    existing = Object.assign({}, newMenuItem);
                }
                else {
                    parent.items.push(Object.assign({}, newMenuItem));
                }
            }
        }
        this.menuItems = menuItems;
    }
    addNewMenuItemToEntities(targetMenu, newMenuItem) {
        let calcRouterLink;
        // Don't add if we already know about this
        if (targetMenu && !targetMenu.find(menu => menu.name === newMenuItem.name)) {
            // Router bits
            if (newMenuItem.routerLink && newMenuItem.routerLink.indexOf(',') > -1) {
                calcRouterLink = newMenuItem.routerLink.split(',');
            }
            else {
                calcRouterLink = newMenuItem.routerLink;
            }
            const createdMenuItem = Object.assign(Object.assign({}, newMenuItem), { routerLink: calcRouterLink });
            targetMenu.push(createdMenuItem);
            if (newMenuItem.items && newMenuItem.items.length > 0) {
                createdMenuItem.items = [];
                const castItems = newMenuItem.items;
                castItems.forEach(menuItem => {
                    this.addNewMenuItemToEntities(createdMenuItem.items, menuItem);
                });
            }
        }
    }
}
MenuService.ɵfac = function MenuService_Factory(t) { return new (t || MenuService)(i0.ɵɵinject(i1.HttpClient), i0.ɵɵinject(i2.MenuStore), i0.ɵɵinject(i3.MenuQuery), i0.ɵɵinject(i4.AppSettingsQuery), i0.ɵɵinject(i5.UserAuthenticationQuery), i0.ɵɵinject(i6.LoggingService), i0.ɵɵinject(i7.RolesService)); };
MenuService.ɵprov = i0.ɵɵdefineInjectable({ token: MenuService, factory: MenuService.ɵfac, providedIn: 'root' });
/*@__PURE__*/ (function () { i0.ɵsetClassMetadata(MenuService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: i1.HttpClient }, { type: i2.MenuStore }, { type: i3.MenuQuery }, { type: i4.AppSettingsQuery }, { type: i5.UserAuthenticationQuery }, { type: i6.LoggingService }, { type: i7.RolesService }]; }, null); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVudS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uLy4uL3Byb2plY3RzL25nc2NhZmZvbGRpbmcvY29yZS9zcmMvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvbWVudS9tZW51LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUUzQyxPQUFPLEVBQUUsZUFBZSxFQUFFLGFBQWEsRUFBRSxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDbEUsT0FBTyxFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUluRCxPQUFPLEVBQWdCLFdBQVcsRUFBYSxNQUFNLHVCQUF1QixDQUFDOzs7Ozs7Ozs7QUFTN0UsTUFBTSxPQUFPLFdBQVc7SUFlcEIsWUFDWSxJQUFnQixFQUNoQixTQUFvQixFQUNwQixTQUFvQixFQUNwQixnQkFBa0MsRUFDbEMsU0FBa0MsRUFDbEMsR0FBbUIsRUFDcEIsWUFBMEI7UUFOekIsU0FBSSxHQUFKLElBQUksQ0FBWTtRQUNoQixjQUFTLEdBQVQsU0FBUyxDQUFXO1FBQ3BCLGNBQVMsR0FBVCxTQUFTLENBQVc7UUFDcEIscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUNsQyxjQUFTLEdBQVQsU0FBUyxDQUF5QjtRQUNsQyxRQUFHLEdBQUgsR0FBRyxDQUFnQjtRQUNwQixpQkFBWSxHQUFaLFlBQVksQ0FBYztRQXJCcEIsZUFBVSxHQUFHLGFBQWEsQ0FBQztRQUNwQyxtQkFBYyxHQUF3QixFQUFFLENBQUM7UUFDekMsV0FBTSxHQUFpQixFQUFFLENBQUM7UUFFMUIsY0FBUyxHQUFtQixFQUFFLENBQUM7UUFJaEMsaUJBQVksR0FBRyxJQUFJLGVBQWUsQ0FBZSxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7UUFFN0QsaUJBQVksR0FBRyxLQUFLLENBQUM7UUFDckIsY0FBUyxHQUFHLENBQUMsQ0FBQztRQUNkLG1CQUFjLEdBQUcsS0FBSyxDQUFDO1FBVzNCLDJDQUEyQztRQUMzQyxhQUFhLENBQUM7WUFDVixJQUFJLENBQUMsU0FBUyxDQUFDLGNBQWM7WUFDN0IsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDO1lBQ3ZELElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQztTQUMzRCxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxhQUFhLEVBQUUsT0FBTyxFQUFFLFFBQVEsQ0FBQyxFQUFFLEVBQUU7WUFDaEQsSUFBSSxhQUFhLElBQUksT0FBTyxJQUFJLFFBQVEsSUFBSSxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUU7Z0JBQzlELElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQztnQkFDN0IsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUU7b0JBQ3BCLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxRQUFRLENBQUMsS0FBSyxJQUFJLEtBQUssQ0FBQyxDQUFDO2lCQUNuRDthQUNKO2lCQUFNLElBQUksQ0FBQyxhQUFhLEVBQUU7Z0JBQ3ZCLElBQUksQ0FBQyxjQUFjLEdBQUcsS0FBSyxDQUFDO2dCQUM1QixJQUFJLENBQUMsU0FBUyxHQUFHLENBQUMsQ0FBQzthQUN0QjtRQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVPLE9BQU87UUFDWCxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7UUFDakIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsZ0NBQWdDLEVBQUUsSUFBSSxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDakYsSUFBSSxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDcEMsQ0FBQztJQUVNLFVBQVUsQ0FBQyxJQUFZO1FBQzFCLElBQUksQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ25DLENBQUM7SUFFTyxVQUFVO1FBQ2QsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQ2pCLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLGdDQUFnQyxFQUFFLElBQUksQ0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBRWpGLElBQUksSUFBSSxDQUFDLFNBQVMsS0FBSyxDQUFDLEVBQUU7WUFDdEIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDcEM7SUFDTCxDQUFDO0lBRU0sb0JBQW9CLENBQUMsU0FBeUIsRUFBRSxRQUFrQixJQUFJO1FBQ3pFLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUNmLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLDRCQUE0QixFQUFFLElBQUksQ0FBQyxVQUFVLEVBQUUsU0FBUyxDQUFDLENBQUM7UUFFeEUsNEJBQTRCO1FBQzVCLElBQUksQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsRUFBRTtZQUNqRCxJQUFJLFVBQVUsRUFBRTtnQkFDWixxQkFBcUI7Z0JBQ3JCLElBQUksQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLENBQUM7Z0JBQzdCLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQzthQUNyQjtRQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVNLFVBQVU7UUFDYixPQUFPLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDO1lBQ3pCLFFBQVEsRUFBRSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLElBQUksMEJBQXFCLENBQUM7U0FDekQsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVNLE1BQU0sQ0FBQyxRQUFzQjtRQUNoQyxPQUFPLElBQUksVUFBVSxDQUFNLFFBQVEsQ0FBQyxFQUFFO1lBQ2xDLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLE9BQU8scUJBQXFCLFFBQVEsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1lBQ2xGLEdBQUcsQ0FBQyxTQUFTLENBQ1QsR0FBRyxFQUFFO2dCQUNELHdCQUF3QjtnQkFDeEIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUVyQyxtQkFBbUI7Z0JBQ25CLE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7Z0JBQ3RGLElBQUksVUFBd0IsQ0FBQztnQkFDN0IsSUFBSSxRQUFRLENBQUMsTUFBTSxFQUFFO29CQUNqQixVQUFVLEdBQUcsYUFBYSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsS0FBSyxRQUFRLENBQUMsTUFBTSxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUM7aUJBQ25IO2dCQUVELE1BQU0sVUFBVSxHQUFJLFVBQVUsQ0FBQyxLQUF3QixDQUFDLFNBQVMsQ0FDN0QsU0FBUyxDQUFDLEVBQUUsQ0FBQyxTQUFTLENBQUMsSUFBSSxJQUFJLFNBQVMsQ0FBQyxJQUFJLEtBQUssUUFBUSxDQUFDLElBQUksQ0FDbEUsQ0FBQztnQkFDRixVQUFVLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDLENBQUM7Z0JBRXZDLGlDQUFpQztnQkFDakMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsRUFBRSxTQUFTLEVBQUUsYUFBYSxFQUFFLENBQUMsQ0FBQztnQkFDcEQsUUFBUSxDQUFDLElBQUksRUFBRSxDQUFDO2dCQUNoQixRQUFRLENBQUMsUUFBUSxFQUFFLENBQUM7WUFDeEIsQ0FBQyxFQUNELEdBQUcsQ0FBQyxFQUFFO2dCQUNGLFFBQVEsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDeEIsQ0FBQyxDQUNKLENBQUM7UUFDTixDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFTSxZQUFZLENBQUMsUUFBc0I7UUFDdEMsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBZSxJQUFJLENBQUMsT0FBTyxHQUFHLG1CQUFtQixFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQ3RGLENBQUM7SUFFTSxzQkFBc0IsQ0FBQyxRQUFzQjtRQUNoRCxvQkFBb0I7UUFDcEIsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3pELElBQUksUUFBUSxFQUFFO1lBQ1YsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztTQUNsRDthQUFNO1lBQ0gsaUNBQWlDO1lBQ2pDLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1NBQ2hDO1FBRUQsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQzFFLElBQUksVUFBd0IsQ0FBQztRQUM3QixJQUFJLFFBQVEsQ0FBQyxNQUFNLEVBQUU7WUFDakIsVUFBVSxHQUFHLGFBQWEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxLQUFLLFFBQVEsQ0FBQyxNQUFNLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQztTQUN0RztRQUNELHFDQUFxQztRQUNyQyxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxFQUFFO1lBQ3ZELFVBQVUsQ0FBQyxLQUFLLEdBQUcsRUFBRSxDQUFDO1NBQ3pCO1FBQ0QsSUFBSSxRQUFRLEVBQUU7WUFDVixNQUFNLFVBQVUsR0FBSSxVQUFVLENBQUMsS0FBd0IsQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQyxTQUFTLENBQUMsSUFBSSxLQUFLLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNqSCxVQUFVLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxHQUFHLFFBQVEsQ0FBQztTQUMzQzthQUFNO1lBQ0YsVUFBVSxDQUFDLEtBQXdCLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1NBQ3ZEO1FBRUQsaUNBQWlDO1FBQ2pDLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLEVBQUUsU0FBUyxFQUFFLGFBQWEsRUFBRSxDQUFDLENBQUM7SUFDeEQsQ0FBQztJQUVELGlCQUFpQjtJQUNULDJCQUEyQixDQUFDLFNBQXlCO1FBQ3pELFNBQVMsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLEVBQUU7WUFDekIsc0JBQXNCO1lBQ3RCLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUM7WUFDL0MsSUFBSSxRQUFRLENBQUMsS0FBSyxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxFQUFFO2dCQUNqRCxJQUFJLENBQUMsMkJBQTJCLENBQUMsUUFBUSxDQUFDLEtBQTRCLENBQUMsQ0FBQzthQUMzRTtRQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVPLDJCQUEyQixDQUFDLFNBQXlCO1FBQ3pELE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDdkMsSUFBSSxTQUFTLEdBQWEsRUFBRSxDQUFDO1FBQzdCLElBQUksSUFBSSxJQUFJLElBQUksQ0FBQyxXQUFXLEVBQUU7WUFDMUIsU0FBUyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDO1NBQ3JDO1FBRUQsTUFBTSxhQUFhLEdBQWEsRUFBRSxDQUFDO1FBQ25DLElBQUksV0FBVyxHQUFtQixJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztRQUV4RSxLQUFLLElBQUksU0FBUyxHQUFHLENBQUMsRUFBRSxTQUFTLEdBQUcsV0FBVyxDQUFDLE1BQU0sRUFBRSxTQUFTLEVBQUUsRUFBRTtZQUNqRSxNQUFNLFFBQVEsR0FBRyxXQUFXLENBQUMsU0FBUyxDQUFDLENBQUM7WUFFeEMsSUFBSSxZQUFZLEdBQUcsS0FBSyxDQUFDO1lBRXpCLDRCQUE0QjtZQUM1QixJQUFJLGFBQWEsR0FBRyxFQUFFLENBQUM7WUFFdkIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLEVBQUU7Z0JBQ2pCLGFBQWEsR0FBRyxFQUFFLENBQUM7YUFDdEI7aUJBQU0sSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsRUFBRTtnQkFDdEMsYUFBYSxHQUFHLENBQUMsR0FBRyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUM7YUFDdkM7aUJBQU07Z0JBQ0gsYUFBYSxHQUFHLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDO2FBQ3BDO1lBRUQseUJBQXlCO1lBQ3pCLElBQUksYUFBYSxJQUFJLGFBQWEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO2dCQUMzQyxJQUFJLFNBQVMsSUFBSSxhQUFhLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7b0JBQ3RHLHVCQUF1QjtvQkFDdkIsWUFBWSxHQUFHLElBQUksQ0FBQztvQkFDcEIsYUFBYSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7aUJBQ3JDO2FBQ0o7WUFFRCxJQUFJLENBQUMsWUFBWSxJQUFJLFFBQVEsQ0FBQyxLQUFLLEVBQUU7Z0JBQ2pDLFFBQVEsQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLDJCQUEyQixDQUFDLFFBQVEsQ0FBQyxLQUF1QixDQUFDLENBQUM7YUFDdkY7U0FDSjtRQUVELElBQUksYUFBYSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDMUIsV0FBVyxHQUFHLFNBQVMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxhQUFhLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsTUFBTSxLQUFLLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQzFHO1FBRUQsT0FBTyxXQUFXLENBQUM7SUFDdkIsQ0FBQztJQUVNLGlCQUFpQixDQUFDLFFBQWlCO1FBQ3RDLHNCQUFzQjtRQUN0QixJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDZixJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQztRQUV6QixNQUFNLFlBQVksR0FBbUIsRUFBRSxDQUFDO1FBRXhDLElBQUksQ0FBQyxJQUFJO2FBQ0osR0FBRyxDQUFzQixHQUFHLElBQUksQ0FBQyxPQUFPLDRCQUE0QixRQUFRLEVBQUUsQ0FBQzthQUMvRSxJQUFJLENBQ0QsT0FBTyxDQUFDLEtBQUssQ0FBQyxFQUNkLFFBQVEsQ0FBQyxHQUFHLEVBQUU7WUFDVixJQUFJLENBQUMsWUFBWSxHQUFHLEtBQUssQ0FBQztZQUMxQixJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7UUFDdEIsQ0FBQyxDQUFDLENBQ0w7YUFDQSxTQUFTLENBQ04sbUJBQW1CLENBQUMsRUFBRTtZQUNsQixJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO1lBQ3RDLElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDO1lBRTNCLElBQUksQ0FBQyxZQUFZLENBQUMsbUJBQW1CLENBQUMsQ0FBQztRQUMzQyxDQUFDLEVBQ0QsR0FBRyxDQUFDLEVBQUU7WUFDRixJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDO1FBQzlDLENBQUMsQ0FDSixDQUFDO0lBQ1YsQ0FBQztJQUVNLFlBQVksQ0FBQyxZQUE0QixFQUFFLFVBQVUsR0FBRyxLQUFLO1FBQ2hFLHdCQUF3QjtRQUN4QixNQUFNLGdCQUFnQixHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxFQUFFLENBQUMsU0FBUyxJQUFJLEVBQUUsQ0FBQztRQUNuRSxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUM7UUFFOUQsSUFBSSxDQUFDLG9CQUFvQixDQUFDLFlBQVksQ0FBQyxDQUFDO1FBRXhDLDZCQUE2QjtRQUM3QixJQUFJLENBQUMsMkJBQTJCLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDL0MsSUFBSSxVQUFVLEVBQUU7WUFDWixZQUFZLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxFQUFFO2dCQUNoQyxJQUFJLENBQUMsNEJBQTRCLENBQUMsWUFBWSxDQUFDLENBQUM7WUFDcEQsQ0FBQyxDQUFDLENBQUM7U0FDTjthQUFNO1lBQ1AsWUFBWSxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsRUFBRTtnQkFDaEMsSUFBSSxDQUFDLHdCQUF3QixDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsWUFBWSxDQUFDLENBQUM7WUFDaEUsQ0FBQyxDQUFDLENBQUM7U0FDRjtRQUVELDBCQUEwQjtRQUMxQixJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQywyQkFBMkIsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7UUFFbEUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsRUFBRSxTQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDLENBQUM7SUFDekQsQ0FBQztJQUVPLG9CQUFvQixDQUFDLFNBQXlCO1FBQ2xELElBQUksU0FBUyxFQUFFO1lBQ1gsU0FBUyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsRUFBRTtnQkFDekIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxVQUFVLEVBQUU7b0JBQ3RCLGdDQUFnQztvQkFDaEMsUUFBUSxRQUFRLENBQUMsSUFBSSxFQUFFO3dCQUNuQixnQ0FBd0IsQ0FBQyxDQUFDOzRCQUN0QixRQUFRLENBQUMsVUFBVSxHQUFHLGFBQWEsUUFBUSxDQUFDLElBQUksRUFBRSxDQUFDOzRCQUNuRCxNQUFNO3lCQUNUO3dCQUNELDhCQUF1QixDQUFDLENBQUM7NEJBQ3JCLFFBQVEsQ0FBQyxVQUFVLEdBQUcsWUFBWSxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUM7NEJBQ2xELE1BQU07eUJBQ1Q7d0JBQ0QsMEJBQXFCLENBQUMsQ0FBQzs0QkFDbkIsc0JBQXNCOzRCQUN0QixNQUFNO3lCQUNUO3dCQUNELE9BQU8sQ0FBQyxDQUFDOzRCQUNMLFFBQVEsQ0FBQyxVQUFVLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQzt5QkFDdkM7cUJBQ0o7aUJBQ0o7Z0JBQ0QsSUFBSSxRQUFRLENBQUMsS0FBSyxFQUFFO29CQUNoQixJQUFJLENBQUMsb0JBQW9CLENBQUMsUUFBUSxDQUFDLEtBQXVCLENBQUMsQ0FBQztpQkFDL0Q7WUFDTCxDQUFDLENBQUMsQ0FBQztTQUNOO0lBQ0wsQ0FBQztJQUVNLFFBQVEsQ0FBQyxLQUFZLEVBQUUsUUFBa0IsSUFBSTtRQUNoRCxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDdkQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFeEIsSUFBSSxLQUFLLEtBQUssSUFBSSxFQUFFO1lBQ2hCLElBQUksQ0FBQyxZQUFZLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUM7U0FDdEQ7SUFDTCxDQUFDO0lBRU8sNEJBQTRCLENBQUMsV0FBeUI7UUFDMUQsTUFBTSxTQUFTLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUN0QyxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sSUFBSSxXQUFXLENBQUMsTUFBTSxLQUFLLEVBQUUsRUFBRTtZQUNsRCxpQkFBaUI7WUFDakIsSUFBSSxRQUFRLEdBQUcsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLEtBQUssV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3RFLElBQUksUUFBUSxFQUFFO2dCQUNWLFFBQVEscUJBQVEsV0FBVyxDQUFFLENBQUM7YUFDakM7aUJBQU07Z0JBQ0gsU0FBUyxDQUFDLElBQUksbUJBQU0sV0FBVyxFQUFHLENBQUM7YUFDdEM7U0FDSjthQUFNO1lBQ0gsZUFBZTtZQUNmLE1BQU0sTUFBTSxHQUFHLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxLQUFLLFdBQVcsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUN4RSxJQUFJLE1BQU0sRUFBRTtnQkFDUixJQUFJLFFBQVEsR0FBSSxNQUFNLENBQUMsS0FBd0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxLQUFLLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDN0YsSUFBSSxRQUFRLEVBQUU7b0JBQ1YsUUFBUSxxQkFBUSxXQUFXLENBQUUsQ0FBQztpQkFDakM7cUJBQU07b0JBQ0YsTUFBTSxDQUFDLEtBQXdCLENBQUMsSUFBSSxtQkFBTSxXQUFXLEVBQUcsQ0FBQztpQkFDN0Q7YUFDSjtTQUNKO1FBQ0QsSUFBSSxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUM7SUFDL0IsQ0FBQztJQUVPLHdCQUF3QixDQUFDLFVBQTBCLEVBQUUsV0FBeUI7UUFDbEYsSUFBSSxjQUFpQyxDQUFDO1FBRXRDLDBDQUEwQztRQUMxQyxJQUFJLFVBQVUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxLQUFLLFdBQVcsQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUN4RSxjQUFjO1lBQ2QsSUFBSSxXQUFXLENBQUMsVUFBVSxJQUFhLFdBQVcsQ0FBQyxVQUFXLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFO2dCQUM5RSxjQUFjLEdBQVksV0FBVyxDQUFDLFVBQVcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7YUFDaEU7aUJBQU07Z0JBQ0gsY0FBYyxHQUFHLFdBQVcsQ0FBQyxVQUFVLENBQUM7YUFDM0M7WUFFRCxNQUFNLGVBQWUsbUNBQXNCLFdBQVcsS0FBRSxVQUFVLEVBQUUsY0FBYyxHQUFFLENBQUM7WUFFckYsVUFBVSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQztZQUVqQyxJQUFJLFdBQVcsQ0FBQyxLQUFLLElBQUksV0FBVyxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO2dCQUNuRCxlQUFlLENBQUMsS0FBSyxHQUFHLEVBQUUsQ0FBQztnQkFDM0IsTUFBTSxTQUFTLEdBQUcsV0FBVyxDQUFDLEtBQXVCLENBQUM7Z0JBQ3RELFNBQVMsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLEVBQUU7b0JBQ3pCLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxlQUFlLENBQUMsS0FBdUIsRUFBRSxRQUFRLENBQUMsQ0FBQztnQkFDckYsQ0FBQyxDQUFDLENBQUM7YUFDTjtTQUNKO0lBQ0wsQ0FBQzs7c0VBM1ZRLFdBQVc7bURBQVgsV0FBVyxXQUFYLFdBQVcsbUJBRlIsTUFBTTtrREFFVCxXQUFXO2NBSHZCLFVBQVU7ZUFBQztnQkFDUixVQUFVLEVBQUUsTUFBTTthQUNyQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJvbGVzU2VydmljZSB9IGZyb20gJy4uL3JvbGVzU2VydmljZS9yb2xlcy5zZXJ2aWNlJztcclxuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBSb3V0ZSB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XHJcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgY29tYmluZUxhdGVzdCwgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyB0aW1lb3V0LCBmaW5hbGl6ZSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuaW1wb3J0IHsgSHR0cENsaWVudCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcclxuXHJcbmltcG9ydCB7IExvZ2dpbmdTZXJ2aWNlIH0gZnJvbSAnLi4vbG9nZ2luZy9sb2dnaW5nLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBDb3JlTWVudUl0ZW0sIEFwcFNldHRpbmdzLCBNZW51VHlwZXMgfSBmcm9tICdAbmdzY2FmZm9sZGluZy9tb2RlbHMnO1xyXG5pbXBvcnQgeyBBcHBTZXR0aW5nc1F1ZXJ5IH0gZnJvbSAnLi4vYXBwU2V0dGluZ3MvYXBwU2V0dGluZ3MucXVlcnknO1xyXG5pbXBvcnQgeyBVc2VyQXV0aGVudGljYXRpb25RdWVyeSB9IGZyb20gJy4uL3VzZXJBdXRoZW50aWNhdGlvbi91c2VyQXV0aGVudGljYXRpb24ucXVlcnknO1xyXG5pbXBvcnQgeyBNZW51U3RvcmUgfSBmcm9tICcuL21lbnUuc3RvcmUnO1xyXG5pbXBvcnQgeyBNZW51UXVlcnkgfSBmcm9tICcuL21lbnUucXVlcnknO1xyXG5cclxuQEluamVjdGFibGUoe1xyXG4gICAgcHJvdmlkZWRJbjogJ3Jvb3QnXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBNZW51U2VydmljZSB7XHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IG1ldGhvZE5hbWUgPSAnTWVudVNlcnZpY2UnO1xyXG4gICAgcHJpdmF0ZSBtYXN0ZXJMaXN0TWVudTogQXJyYXk8Q29yZU1lbnVJdGVtPiA9IFtdO1xyXG4gICAgcHJpdmF0ZSByb3V0ZXM6IEFycmF5PFJvdXRlPiA9IFtdO1xyXG5cclxuICAgIHByaXZhdGUgbWVudUl0ZW1zOiBDb3JlTWVudUl0ZW1bXSA9IFtdO1xyXG5cclxuICAgIHByaXZhdGUgYXBpSG9tZTogc3RyaW5nO1xyXG5cclxuICAgIHB1YmxpYyByb3V0ZVN1YmplY3QgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PEFycmF5PFJvdXRlPj4odGhpcy5yb3V0ZXMpO1xyXG5cclxuICAgIHByaXZhdGUgaHR0cEluRmxpZ2h0ID0gZmFsc2U7XHJcbiAgICBwcml2YXRlIGxvY2tDb3VudCA9IDA7XHJcbiAgICBwcml2YXRlIG1lbnVEb3dubG9hZGVkID0gZmFsc2U7XHJcblxyXG4gICAgY29uc3RydWN0b3IoXHJcbiAgICAgICAgcHJpdmF0ZSBodHRwOiBIdHRwQ2xpZW50LFxyXG4gICAgICAgIHByaXZhdGUgbWVudVN0b3JlOiBNZW51U3RvcmUsXHJcbiAgICAgICAgcHJpdmF0ZSBtZW51UXVlcnk6IE1lbnVRdWVyeSxcclxuICAgICAgICBwcml2YXRlIGFwcFNldHRpbmdzUXVlcnk6IEFwcFNldHRpbmdzUXVlcnksXHJcbiAgICAgICAgcHJpdmF0ZSBhdXRoUXVlcnk6IFVzZXJBdXRoZW50aWNhdGlvblF1ZXJ5LFxyXG4gICAgICAgIHByaXZhdGUgbG9nOiBMb2dnaW5nU2VydmljZSxcclxuICAgICAgICBwdWJsaWMgcm9sZXNTZXJ2aWNlOiBSb2xlc1NlcnZpY2VcclxuICAgICkge1xyXG4gICAgICAgIC8vIFdhaXQgZm9yIHNldHRpbmdzLCB0aGVuIGxvYWQgZnJvbSBzZXJ2ZXJcclxuICAgICAgICBjb21iaW5lTGF0ZXN0KFtcclxuICAgICAgICAgICAgdGhpcy5hdXRoUXVlcnkuYXV0aGVudGljYXRlZCQsXHJcbiAgICAgICAgICAgIHRoaXMuYXBwU2V0dGluZ3NRdWVyeS5zZWxlY3RFbnRpdHkoQXBwU2V0dGluZ3MuYXBpSG9tZSksXHJcbiAgICAgICAgICAgIHRoaXMuYXBwU2V0dGluZ3NRdWVyeS5zZWxlY3RFbnRpdHkoQXBwU2V0dGluZ3MuaXNNb2JpbGUpXHJcbiAgICAgICAgXSkuc3Vic2NyaWJlKChbYXV0aGVudGljYXRlZCwgYXBpSG9tZSwgaXNNb2JpbGVdKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChhdXRoZW50aWNhdGVkICYmIGFwaUhvbWUgJiYgaXNNb2JpbGUgJiYgIXRoaXMubWVudURvd25sb2FkZWQpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuYXBpSG9tZSA9IGFwaUhvbWUudmFsdWU7XHJcbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaHR0cEluRmxpZ2h0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kb3dubG9hZE1lbnVJdGVtcyhpc01vYmlsZS52YWx1ZSB8fCBmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoIWF1dGhlbnRpY2F0ZWQpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMubWVudURvd25sb2FkZWQgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgIHRoaXMubG9ja0NvdW50ID0gMDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgYWRkTG9jaygpIHtcclxuICAgICAgICB0aGlzLmxvY2tDb3VudCsrO1xyXG4gICAgICAgIHRoaXMubG9nLmluZm8oYE1FTlUgU2VydmljZTogTG9ja3Mgb24gTG9hZGluZ2AsIHRoaXMubWV0aG9kTmFtZSwgdGhpcy5sb2NrQ291bnQpO1xyXG4gICAgICAgIHRoaXMubWVudVN0b3JlLnNldExvYWRpbmcodHJ1ZSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHNldEN1cnJlbnQobmFtZTogc3RyaW5nKSB7XHJcbiAgICAgICAgdGhpcy5tZW51U3RvcmUuc2V0QWN0aXZlKG5hbWUpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgcmVtb3ZlTG9jaygpIHtcclxuICAgICAgICB0aGlzLmxvY2tDb3VudC0tO1xyXG4gICAgICAgIHRoaXMubG9nLmluZm8oYE1FTlUgU2VydmljZTogTG9ja3Mgb24gTG9hZGluZ2AsIHRoaXMubWV0aG9kTmFtZSwgdGhpcy5sb2NrQ291bnQpO1xyXG5cclxuICAgICAgICBpZiAodGhpcy5sb2NrQ291bnQgPT09IDApIHtcclxuICAgICAgICAgICAgdGhpcy5tZW51U3RvcmUuc2V0TG9hZGluZyhmYWxzZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBhZGRNZW51SXRlbXNGcm9tQ29kZShtZW51SXRlbXM6IENvcmVNZW51SXRlbVtdLCByb2xlczogc3RyaW5nW10gPSBudWxsKSB7XHJcbiAgICAgICAgdGhpcy5hZGRMb2NrKCk7XHJcbiAgICAgICAgdGhpcy5sb2cuaW5mbygnQWRkaW5nIE1lbnVJdGVtcyBtZW51SXRlbXMnLCB0aGlzLm1ldGhvZE5hbWUsIG1lbnVJdGVtcyk7XHJcblxyXG4gICAgICAgIC8vIFdhaXQgdGlsbCB1c2VyIGF1dGhvcmlzZWRcclxuICAgICAgICB0aGlzLmF1dGhRdWVyeS5hdXRoZW50aWNhdGVkJC5zdWJzY3JpYmUoYXV0aG9yaXNlZCA9PiB7XHJcbiAgICAgICAgICAgIGlmIChhdXRob3Jpc2VkKSB7XHJcbiAgICAgICAgICAgICAgICAvLyBTYXZlIGZvciBsYXRlciB1c2VcclxuICAgICAgICAgICAgICAgIHRoaXMuYWRkTWVudUl0ZW1zKG1lbnVJdGVtcyk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZUxvY2soKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBnZXRGb2xkZXJzKCk6IENvcmVNZW51SXRlbVtdIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5tZW51UXVlcnkuZ2V0QWxsKHtcclxuICAgICAgICAgICAgZmlsdGVyQnk6IFtlbnRpdHkgPT4gZW50aXR5LnR5cGUgPT09IE1lbnVUeXBlcy5Gb2xkZXJdXHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGRlbGV0ZShtZW51SXRlbTogQ29yZU1lbnVJdGVtKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgICAgICByZXR1cm4gbmV3IE9ic2VydmFibGU8YW55PihvYnNlcnZlciA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IG9icyA9IHRoaXMuaHR0cC5kZWxldGUoYCR7dGhpcy5hcGlIb21lfS9hcGkvdjEvbWVudWl0ZW1zLyR7bWVudUl0ZW0ubmFtZX1gKTtcclxuICAgICAgICAgICAgb2JzLnN1YnNjcmliZShcclxuICAgICAgICAgICAgICAgICgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAvLyBSZW1vdmUgZnJvbSBvdXIgc3RvcmVcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLm1lbnVTdG9yZS5yZW1vdmUobWVudUl0ZW0ubmFtZSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIC8vIFJlbW92ZSBmcm9tIFRyZWVcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBleGlzdGluZ01lbnVzID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeSh0aGlzLm1lbnVRdWVyeS5nZXRWYWx1ZSgpKSkubWVudUl0ZW1zO1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBwYXJlbnRNZW51OiBDb3JlTWVudUl0ZW07XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKG1lbnVJdGVtLnBhcmVudCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRNZW51ID0gZXhpc3RpbmdNZW51cy5maW5kKG1lbnUgPT4gbWVudS5uYW1lICYmIG1lbnUubmFtZS50b0xvd2VyQ2FzZSgpID09PSBtZW51SXRlbS5wYXJlbnQudG9Mb3dlckNhc2UoKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBmb3VuZEluZGV4ID0gKHBhcmVudE1lbnUuaXRlbXMgYXMgQ29yZU1lbnVJdGVtW10pLmZpbmRJbmRleChcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRNZW51ID0+IGNoaWxkTWVudS5uYW1lICYmIGNoaWxkTWVudS5uYW1lID09PSBtZW51SXRlbS5uYW1lXHJcbiAgICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgICAgICBwYXJlbnRNZW51Lml0ZW1zLnNwbGljZShmb3VuZEluZGV4LCAxKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgLy8gVXBkYXRlIHRyZWUgYW5kIHRlbGwgdGhlIHdvcmxkXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZW51U3RvcmUudXBkYXRlKHsgbWVudUl0ZW1zOiBleGlzdGluZ01lbnVzIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIG9ic2VydmVyLm5leHQoKTtcclxuICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIGVyciA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgb2JzZXJ2ZXIuZXJyb3IoZXJyKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgc2F2ZU1lbnVJdGVtKG1lbnVJdGVtOiBDb3JlTWVudUl0ZW0pOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmh0dHAucG9zdDxDb3JlTWVudUl0ZW0+KHRoaXMuYXBpSG9tZSArICcvYXBpL3YxL21lbnVpdGVtcycsIG1lbnVJdGVtKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgdXBkYXRlRXhpc3RpbmdNZW51SXRlbShtZW51SXRlbTogQ29yZU1lbnVJdGVtKSB7XHJcbiAgICAgICAgLy8gSXMgdGhpcyBleGlzdGluZz9cclxuICAgICAgICBjb25zdCBleGlzdGluZyA9IHRoaXMubWVudVF1ZXJ5Lmhhc0VudGl0eShtZW51SXRlbS5uYW1lKTtcclxuICAgICAgICBpZiAoZXhpc3RpbmcpIHtcclxuICAgICAgICAgICAgdGhpcy5tZW51U3RvcmUudXBzZXJ0KG1lbnVJdGVtLm5hbWUsIG1lbnVJdGVtKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAvLyBBZGQgdG8gcmVmZXJlbmNlIGxpc3Qgb2YgbWVudXNcclxuICAgICAgICAgICAgdGhpcy5tZW51U3RvcmUuYWRkKG1lbnVJdGVtKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGV4aXN0aW5nTWVudXMgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHRoaXMubWVudVF1ZXJ5LmdldEFsbCgpKSk7XHJcbiAgICAgICAgbGV0IHBhcmVudE1lbnU6IENvcmVNZW51SXRlbTtcclxuICAgICAgICBpZiAobWVudUl0ZW0ucGFyZW50KSB7XHJcbiAgICAgICAgICAgIHBhcmVudE1lbnUgPSBleGlzdGluZ01lbnVzLmZpbmQobWVudSA9PiBtZW51Lm5hbWUudG9Mb3dlckNhc2UoKSA9PT0gbWVudUl0ZW0ucGFyZW50LnRvTG93ZXJDYXNlKCkpO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBBZGQgdG8gdHJlZXZpZXcgZm9yIG1lbnUgcmVuZGVyaW5nXHJcbiAgICAgICAgaWYgKCFwYXJlbnRNZW51Lml0ZW1zIHx8ICFBcnJheS5pc0FycmF5KHBhcmVudE1lbnUuaXRlbXMpKSB7XHJcbiAgICAgICAgICAgIHBhcmVudE1lbnUuaXRlbXMgPSBbXTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGV4aXN0aW5nKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGZvdW5kSW5kZXggPSAocGFyZW50TWVudS5pdGVtcyBhcyBDb3JlTWVudUl0ZW1bXSkuZmluZEluZGV4KGNoaWxkTWVudSA9PiBjaGlsZE1lbnUubmFtZSA9PT0gbWVudUl0ZW0ubmFtZSk7XHJcbiAgICAgICAgICAgIHBhcmVudE1lbnUuaXRlbXNbZm91bmRJbmRleF0gPSBtZW51SXRlbTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAocGFyZW50TWVudS5pdGVtcyBhcyBDb3JlTWVudUl0ZW1bXSkucHVzaChtZW51SXRlbSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBVcGRhdGUgdHJlZSBhbmQgdGVsbCB0aGUgd29ybGRcclxuICAgICAgICB0aGlzLm1lbnVTdG9yZS51cGRhdGUoeyBtZW51SXRlbXM6IGV4aXN0aW5nTWVudXMgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gSXRlcmF0aXZlIENhbGxcclxuICAgIHByaXZhdGUgYWRkTWVudUl0ZW1zVG9SZWZlcmVuY2VMaXN0KG1lbnVJdGVtczogQ29yZU1lbnVJdGVtW10pOiB2b2lkIHtcclxuICAgICAgICBtZW51SXRlbXMuZm9yRWFjaChtZW51SXRlbSA9PiB7XHJcbiAgICAgICAgICAgIC8vIEFkZCB0byBFbnRpdHkgU3RvcmVcclxuICAgICAgICAgICAgdGhpcy5tZW51U3RvcmUudXBzZXJ0KG1lbnVJdGVtLm5hbWUsIG1lbnVJdGVtKTtcclxuICAgICAgICAgICAgaWYgKG1lbnVJdGVtLml0ZW1zICYmIEFycmF5LmlzQXJyYXkobWVudUl0ZW0uaXRlbXMpKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmFkZE1lbnVJdGVtc1RvUmVmZXJlbmNlTGlzdChtZW51SXRlbS5pdGVtcyBhcyBBcnJheTxDb3JlTWVudUl0ZW0+KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgcmVtb3ZlVW5hdXRob3Jpc2VkTWVudUl0ZW1zKG1lbnVJdGVtczogQ29yZU1lbnVJdGVtW10pOiBDb3JlTWVudUl0ZW1bXSB7XHJcbiAgICAgICAgY29uc3QgdXNlciA9IHRoaXMuYXV0aFF1ZXJ5LmdldFZhbHVlKCk7XHJcbiAgICAgICAgbGV0IHVzZXJSb2xlczogc3RyaW5nW10gPSBbXTtcclxuICAgICAgICBpZiAodXNlciAmJiB1c2VyLnVzZXJEZXRhaWxzKSB7XHJcbiAgICAgICAgICAgIHVzZXJSb2xlcyA9IHVzZXIudXNlckRldGFpbHMucm9sZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IHJlbW92aW5nTWVudXM6IHN0cmluZ1tdID0gW107XHJcbiAgICAgICAgbGV0IHJldHVybk1lbnVzOiBDb3JlTWVudUl0ZW1bXSA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkobWVudUl0ZW1zKSk7XHJcblxyXG4gICAgICAgIGZvciAobGV0IG1lbnVJbmRleCA9IDA7IG1lbnVJbmRleCA8IHJldHVybk1lbnVzLmxlbmd0aDsgbWVudUluZGV4KyspIHtcclxuICAgICAgICAgICAgY29uc3QgbWVudUl0ZW0gPSByZXR1cm5NZW51c1ttZW51SW5kZXhdO1xyXG5cclxuICAgICAgICAgICAgbGV0IHJlbW92aW5nVGhpcyA9IGZhbHNlO1xyXG5cclxuICAgICAgICAgICAgLy8gbWFrZXMgc3VyZSByb2xlcyBpcyBhcnJheVxyXG4gICAgICAgICAgICBsZXQgY2hlY2tpbmdSb2xlcyA9IFtdO1xyXG5cclxuICAgICAgICAgICAgaWYgKCFtZW51SXRlbS5yb2xlcykge1xyXG4gICAgICAgICAgICAgICAgY2hlY2tpbmdSb2xlcyA9IFtdO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkobWVudUl0ZW0ucm9sZXMpKSB7XHJcbiAgICAgICAgICAgICAgICBjaGVja2luZ1JvbGVzID0gWy4uLm1lbnVJdGVtLnJvbGVzXTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGNoZWNraW5nUm9sZXMgPSBbbWVudUl0ZW0ucm9sZXNdO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvLyBJcyB0aGlzIHJvbGUgcHJvdGVjdGVkXHJcbiAgICAgICAgICAgIGlmIChjaGVja2luZ1JvbGVzICYmIGNoZWNraW5nUm9sZXMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgaWYgKHVzZXJSb2xlcyAmJiBjaGVja2luZ1JvbGVzLmZpbHRlcihhbGxvd2VkUm9sZSA9PiB1c2VyUm9sZXMuaW5kZXhPZihhbGxvd2VkUm9sZSkgIT09IC0xKS5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyBObyBBdXRob3JpdHkuIFJlbW92ZVxyXG4gICAgICAgICAgICAgICAgICAgIHJlbW92aW5nVGhpcyA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVtb3ZpbmdNZW51cy5wdXNoKG1lbnVJdGVtLm5hbWUpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAoIXJlbW92aW5nVGhpcyAmJiBtZW51SXRlbS5pdGVtcykge1xyXG4gICAgICAgICAgICAgICAgbWVudUl0ZW0uaXRlbXMgPSB0aGlzLnJlbW92ZVVuYXV0aG9yaXNlZE1lbnVJdGVtcyhtZW51SXRlbS5pdGVtcyBhcyBDb3JlTWVudUl0ZW1bXSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChyZW1vdmluZ01lbnVzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgcmV0dXJuTWVudXMgPSBtZW51SXRlbXMuZmlsdGVyKG1lbnUgPT4gcmVtb3ZpbmdNZW51cy5maW5kSW5kZXgocmVtb3ZlID0+IHJlbW92ZSA9PT0gbWVudS5uYW1lKSA9PT0gLTEpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHJldHVybk1lbnVzO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBkb3dubG9hZE1lbnVJdGVtcyhpc01vYmlsZTogYm9vbGVhbikge1xyXG4gICAgICAgIC8vIE1hcmsgbG9hZGluZyBzdGF0dXNcclxuICAgICAgICB0aGlzLmFkZExvY2soKTtcclxuICAgICAgICB0aGlzLmh0dHBJbkZsaWdodCA9IHRydWU7XHJcblxyXG4gICAgICAgIGNvbnN0IG5ld01lbnVJdGVtczogQ29yZU1lbnVJdGVtW10gPSBbXTtcclxuXHJcbiAgICAgICAgdGhpcy5odHRwXHJcbiAgICAgICAgICAgIC5nZXQ8QXJyYXk8Q29yZU1lbnVJdGVtPj4oYCR7dGhpcy5hcGlIb21lfS9hcGkvdjEvbWVudWl0ZW1zP21vYmlsZT0ke2lzTW9iaWxlfWApXHJcbiAgICAgICAgICAgIC5waXBlKFxyXG4gICAgICAgICAgICAgICAgdGltZW91dCg2MDAwMCksXHJcbiAgICAgICAgICAgICAgICBmaW5hbGl6ZSgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5odHRwSW5GbGlnaHQgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZUxvY2soKTtcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIClcclxuICAgICAgICAgICAgLnN1YnNjcmliZShcclxuICAgICAgICAgICAgICAgIGRvd25sb2FkZWRNZW51SXRlbXMgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMubG9nLmluZm8oYERvd25sb2FkZWQgTWVudUl0ZW1zYCk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZW51RG93bmxvYWRlZCA9IHRydWU7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYWRkTWVudUl0ZW1zKGRvd25sb2FkZWRNZW51SXRlbXMpO1xyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIGVyciA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2cuZXJyb3IoJ0ZhaWxlZCB0byBkb3dubG9hZCBNZW51Jyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGFkZE1lbnVJdGVtcyhuZXdNZW51SXRlbXM6IENvcmVNZW51SXRlbVtdLCBmaW5kSW5UcmVlID0gZmFsc2UpIHtcclxuICAgICAgICAvLyBDbG9uZSBzbyB3ZSBjYW4gYW1lbmRcclxuICAgICAgICBjb25zdCBmZXRjaGVkTWVudUl0ZW1zID0gdGhpcy5tZW51UXVlcnkuZ2V0VmFsdWUoKS5tZW51SXRlbXMgfHwgW107XHJcbiAgICAgICAgdGhpcy5tZW51SXRlbXMgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KGZldGNoZWRNZW51SXRlbXMpKTtcclxuXHJcbiAgICAgICAgdGhpcy5jYWxjdWxhdGVSb3V0ZXJMaW5rcyhuZXdNZW51SXRlbXMpO1xyXG5cclxuICAgICAgICAvLyBBZGQgdG8gZmxhdCByZWZlcmVuY2UgTGlzdFxyXG4gICAgICAgIHRoaXMuYWRkTWVudUl0ZW1zVG9SZWZlcmVuY2VMaXN0KG5ld01lbnVJdGVtcyk7XHJcbiAgICAgICAgaWYgKGZpbmRJblRyZWUpIHtcclxuICAgICAgICAgICAgbmV3TWVudUl0ZW1zLmZvckVhY2gobG9vcE1lbnVJdGVtID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMudXBzZXJ0TWVudUl0ZW1Ub0V4aXN0aW5nVHJlZShsb29wTWVudUl0ZW0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgIG5ld01lbnVJdGVtcy5mb3JFYWNoKGxvb3BNZW51SXRlbSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuYWRkTmV3TWVudUl0ZW1Ub0VudGl0aWVzKHRoaXMubWVudUl0ZW1zLCBsb29wTWVudUl0ZW0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gUmVtb3ZlIHRoZSB1bmF0dWhvcmlzZWRcclxuICAgICAgICB0aGlzLm1lbnVJdGVtcyA9IHRoaXMucmVtb3ZlVW5hdXRob3Jpc2VkTWVudUl0ZW1zKHRoaXMubWVudUl0ZW1zKTtcclxuXHJcbiAgICAgICAgdGhpcy5tZW51U3RvcmUudXBkYXRlKHsgbWVudUl0ZW1zOiB0aGlzLm1lbnVJdGVtcyB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGNhbGN1bGF0ZVJvdXRlckxpbmtzKG1lbnVJdGVtczogQ29yZU1lbnVJdGVtW10pIHtcclxuICAgICAgICBpZiAobWVudUl0ZW1zKSB7XHJcbiAgICAgICAgICAgIG1lbnVJdGVtcy5mb3JFYWNoKG1lbnVJdGVtID0+IHtcclxuICAgICAgICAgICAgICAgIGlmICghbWVudUl0ZW0ucm91dGVyTGluaykge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIE5lZWQgdG8gY3JlYXRlIG91ciByb3V0ZXJMaW5rXHJcbiAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChtZW51SXRlbS50eXBlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgTWVudVR5cGVzLkRhc2hib2FyZDoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVudUl0ZW0ucm91dGVyTGluayA9IGBkYXNoYm9hcmQvJHttZW51SXRlbS5uYW1lfWA7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlIE1lbnVUeXBlcy5EYXRhZ3JpZDoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVudUl0ZW0ucm91dGVyTGluayA9IGBkYXRhZ3JpZC8ke21lbnVJdGVtLm5hbWV9YDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgTWVudVR5cGVzLkZvbGRlcjoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gTm8gcm91dGVyIGxpbmsgaGVyZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVudUl0ZW0ucm91dGVyTGluayA9IG1lbnVJdGVtLm5hbWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAobWVudUl0ZW0uaXRlbXMpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbGN1bGF0ZVJvdXRlckxpbmtzKG1lbnVJdGVtLml0ZW1zIGFzIENvcmVNZW51SXRlbVtdKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBhZGRSb3V0ZShyb3V0ZTogUm91dGUsIHJvbGVzOiBzdHJpbmdbXSA9IG51bGwpIHtcclxuICAgICAgICB0aGlzLmxvZy5pbmZvKGBBZGRpbmcgUm91dGUgJHtKU09OLnN0cmluZ2lmeShyb3V0ZSl9YCk7XHJcbiAgICAgICAgdGhpcy5yb3V0ZXMucHVzaChyb3V0ZSk7XHJcblxyXG4gICAgICAgIGlmIChyb2xlcyAhPT0gbnVsbCkge1xyXG4gICAgICAgICAgICB0aGlzLnJvbGVzU2VydmljZS5hZGRSb3V0ZVJvbGVzKHJvdXRlLnBhdGgsIHJvbGVzKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSB1cHNlcnRNZW51SXRlbVRvRXhpc3RpbmdUcmVlKG5ld01lbnVJdGVtOiBDb3JlTWVudUl0ZW0pIHtcclxuICAgICAgICBjb25zdCBtZW51SXRlbXMgPSBbLi4udGhpcy5tZW51SXRlbXNdO1xyXG4gICAgICAgIGlmICghbmV3TWVudUl0ZW0ucGFyZW50IHx8IG5ld01lbnVJdGVtLnBhcmVudCA9PT0gJycpIHtcclxuICAgICAgICAgICAgLy8gUm9vdCBtZW51IGl0ZW1cclxuICAgICAgICAgICAgbGV0IGV4aXN0aW5nID0gbWVudUl0ZW1zLmZpbmQobWVudSA9PiBtZW51Lm5hbWUgPT09IG5ld01lbnVJdGVtLm5hbWUpO1xyXG4gICAgICAgICAgICBpZiAoZXhpc3RpbmcpIHtcclxuICAgICAgICAgICAgICAgIGV4aXN0aW5nID0geyAuLi5uZXdNZW51SXRlbSB9O1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgbWVudUl0ZW1zLnB1c2goeyAuLi5uZXdNZW51SXRlbSB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIC8vIFN1Ym1lbnUgaXRlbVxyXG4gICAgICAgICAgICBjb25zdCBwYXJlbnQgPSBtZW51SXRlbXMuZmluZChtZW51ID0+IG1lbnUubmFtZSA9PT0gbmV3TWVudUl0ZW0ucGFyZW50KTtcclxuICAgICAgICAgICAgaWYgKHBhcmVudCkge1xyXG4gICAgICAgICAgICAgICAgbGV0IGV4aXN0aW5nID0gKHBhcmVudC5pdGVtcyBhcyBDb3JlTWVudUl0ZW1bXSkuZmluZChtZW51ID0+IG1lbnUubmFtZSA9PT0gbmV3TWVudUl0ZW0ubmFtZSk7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXhpc3RpbmcpIHtcclxuICAgICAgICAgICAgICAgICAgICBleGlzdGluZyA9IHsgLi4ubmV3TWVudUl0ZW0gfTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgKHBhcmVudC5pdGVtcyBhcyBDb3JlTWVudUl0ZW1bXSkucHVzaCh7IC4uLm5ld01lbnVJdGVtIH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMubWVudUl0ZW1zID0gbWVudUl0ZW1zO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgYWRkTmV3TWVudUl0ZW1Ub0VudGl0aWVzKHRhcmdldE1lbnU6IENvcmVNZW51SXRlbVtdLCBuZXdNZW51SXRlbTogQ29yZU1lbnVJdGVtKSB7XHJcbiAgICAgICAgbGV0IGNhbGNSb3V0ZXJMaW5rOiBzdHJpbmcgfCBzdHJpbmdbXTtcclxuXHJcbiAgICAgICAgLy8gRG9uJ3QgYWRkIGlmIHdlIGFscmVhZHkga25vdyBhYm91dCB0aGlzXHJcbiAgICAgICAgaWYgKHRhcmdldE1lbnUgJiYgIXRhcmdldE1lbnUuZmluZChtZW51ID0+IG1lbnUubmFtZSA9PT0gbmV3TWVudUl0ZW0ubmFtZSkpIHtcclxuICAgICAgICAgICAgLy8gUm91dGVyIGJpdHNcclxuICAgICAgICAgICAgaWYgKG5ld01lbnVJdGVtLnJvdXRlckxpbmsgJiYgKDxzdHJpbmc+bmV3TWVudUl0ZW0ucm91dGVyTGluaykuaW5kZXhPZignLCcpID4gLTEpIHtcclxuICAgICAgICAgICAgICAgIGNhbGNSb3V0ZXJMaW5rID0gKDxzdHJpbmc+bmV3TWVudUl0ZW0ucm91dGVyTGluaykuc3BsaXQoJywnKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGNhbGNSb3V0ZXJMaW5rID0gbmV3TWVudUl0ZW0ucm91dGVyTGluaztcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgY29uc3QgY3JlYXRlZE1lbnVJdGVtOiBDb3JlTWVudUl0ZW0gPSB7IC4uLm5ld01lbnVJdGVtLCByb3V0ZXJMaW5rOiBjYWxjUm91dGVyTGluayB9O1xyXG5cclxuICAgICAgICAgICAgdGFyZ2V0TWVudS5wdXNoKGNyZWF0ZWRNZW51SXRlbSk7XHJcblxyXG4gICAgICAgICAgICBpZiAobmV3TWVudUl0ZW0uaXRlbXMgJiYgbmV3TWVudUl0ZW0uaXRlbXMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgY3JlYXRlZE1lbnVJdGVtLml0ZW1zID0gW107XHJcbiAgICAgICAgICAgICAgICBjb25zdCBjYXN0SXRlbXMgPSBuZXdNZW51SXRlbS5pdGVtcyBhcyBDb3JlTWVudUl0ZW1bXTtcclxuICAgICAgICAgICAgICAgIGNhc3RJdGVtcy5mb3JFYWNoKG1lbnVJdGVtID0+IHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmFkZE5ld01lbnVJdGVtVG9FbnRpdGllcyhjcmVhdGVkTWVudUl0ZW0uaXRlbXMgYXMgQ29yZU1lbnVJdGVtW10sIG1lbnVJdGVtKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59XHJcbiJdfQ==