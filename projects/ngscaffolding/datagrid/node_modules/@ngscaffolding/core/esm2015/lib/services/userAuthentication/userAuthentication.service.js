import { Observable } from 'rxjs';
import { timeout } from 'rxjs/operators';
import { Injectable } from '@angular/core';
import { HttpParams, HttpHeaders } from '@angular/common/http';
import { BasicUser, AppSettings } from '@ngscaffolding/models';
import { JwtHelperService } from '@auth0/angular-jwt';
import { resetStores } from '@datorama/akita';
import * as i0 from "@angular/core";
import * as i1 from "../logging/logging.service";
import * as i2 from "@angular/common/http";
import * as i3 from "./userAuthentication.store";
import * as i4 from "./userAuthentication.query";
import * as i5 from "../appSettings/appSettings.service";
import * as i6 from "@angular/router";
export class UserAuthenticationService {
    constructor(logger, http, authStore, authQuery, appSettingsService, router) {
        this.logger = logger;
        this.http = http;
        this.authStore = authStore;
        this.authQuery = authQuery;
        this.appSettingsService = appSettingsService;
        this.router = router;
        this.tokenStorageKey = 'USER_TOKEN';
        logger.info('UserAuthorisationService - Constructor');
        this.jwtHelper = new JwtHelperService({});
        this.loadUserTokenFromStorage();
    }
    filterItemsByRole(authItems) {
        const returnItems = [];
        if (authItems) {
            authItems.forEach(authItem => {
                if (this.checkByRoles(authItem)) {
                    returnItems.push(authItem);
                }
            });
        }
        return returnItems;
    }
    // Check if user passes muster
    checkByRoles(authItem) {
        // No roles = always okay
        if (!authItem.roles) {
            return true;
        }
        let isAllowed = false;
        const user = this.authQuery.getUser();
        if (user.role) {
            user.role.forEach(role => {
                authItem.roles.forEach(authRole => {
                    if (role === authRole) {
                        isAllowed = true;
                    }
                });
            });
        }
        return isAllowed;
    }
    completeAuthentication() { }
    isAuthenticated() {
        const token = this.getToken();
        const tokenDetails = this.jwtHelper.decodeToken(token);
        return tokenDetails && !this.jwtHelper.isTokenExpired(token);
    }
    authorizationHeaderValue() { }
    name() {
        return 'Hello World';
    }
    forceLogon(returnUrl) {
        this.logoff();
        this.router.navigate(['login'], { queryParams: { returnUrl: returnUrl } });
    }
    getToken() {
        return this.authQuery.getValue().token;
    }
    loadUserTokenFromStorage() {
        const savedToken = localStorage.getItem(this.tokenStorageKey); // Loaded from Saved Storage
        if (savedToken !== null) {
            // New AuthUser Based on Token
            if (!this.jwtHelper.isTokenExpired(savedToken)) {
                // If all Good
                this.logger.info('Token from Storage - Token Loaded and not Expired');
                this.setToken(savedToken);
            }
            else {
                // Expired Token
                this.logger.info('Token from Storage - Token Expired - Not using');
            }
        }
        else {
            // No token
            this.logger.info('Token from Storage - No Token Available');
        }
    }
    setToken(token) {
        // New AuthUser Based on Token
        const tokenDetails = this.jwtHelper.decodeToken(token);
        const newUser = new BasicUser();
        if (tokenDetails['firstName'] && tokenDetails['lastName']) {
            newUser.name = tokenDetails['firstName'] + ' ' + tokenDetails['lastName'];
        }
        if (tokenDetails['sub']) {
            newUser.userId = tokenDetails['sub'];
        }
        if (tokenDetails['role']) {
            newUser.role = tokenDetails['role'];
        }
        if (tokenDetails['email']) {
            newUser.email = tokenDetails['email'];
        }
        this.authStore.update({ token: token, userDetails: newUser, authenticated: true });
    }
    logon(userName, password) {
        return new Observable(observer => {
            let body = new HttpParams();
            body = body
                .append('username', userName)
                .append('password', password)
                .append('grant_type', 'password')
                .append('client_id', this.appSettingsService.getValue(AppSettings.authClientId))
                .append('client_secret', this.appSettingsService.getValue(AppSettings.authClientSecret))
                .append('scope', this.appSettingsService.getValue(AppSettings.authScope) + ' offline_access openid');
            this.http
                .post(this.appSettingsService.getValue(AppSettings.apiAuth) + this.appSettingsService.getValue(AppSettings.authTokenEndpoint), body, {
                headers: new HttpHeaders().set('Content-Type', 'application/x-www-form-urlencoded')
            })
                .pipe(timeout(30000))
                .subscribe(response => {
                // chek if user is is in 'user' role
                const tokenDetails = this.jwtHelper.decodeToken(response['access_token']);
                const requiredRole = this.appSettingsService.getValue(AppSettings.authRequiredRole);
                if (tokenDetails['role']) {
                    if (requiredRole && !tokenDetails['role'].includes(requiredRole)) {
                        observer.error('Unauthorised');
                    }
                    else {
                        // Save Token in Storage if needed
                        if (this.appSettingsService.getValue(AppSettings.authSaveinLocalStorage)) {
                            localStorage.setItem(this.tokenStorageKey, response['access_token']);
                        }
                        // Load our details from this token
                        this.setToken(response['access_token']);
                        if (response['refresh_token']) {
                            // this.refreshToken = response['refresh_token'];
                        }
                        observer.next(null);
                        observer.complete();
                    }
                }
            }, err => {
                observer.error(err);
            });
        });
    }
    logoff() {
        if (this.appSettingsService.getValue(AppSettings.authSaveinLocalStorage)) {
            // Remove token from Local Storage
            localStorage.removeItem(this.tokenStorageKey);
        }
        // Clear Akita Stores
        resetStores({ exclude: ['appSettings'] });
        this.authStore.update({ token: null, userDetails: null, authenticated: false });
    }
}
UserAuthenticationService.ɵfac = function UserAuthenticationService_Factory(t) { return new (t || UserAuthenticationService)(i0.ɵɵinject(i1.LoggingService), i0.ɵɵinject(i2.HttpClient), i0.ɵɵinject(i3.AuthenticationStore), i0.ɵɵinject(i4.UserAuthenticationQuery), i0.ɵɵinject(i5.AppSettingsService), i0.ɵɵinject(i6.Router)); };
UserAuthenticationService.ɵprov = i0.ɵɵdefineInjectable({ token: UserAuthenticationService, factory: UserAuthenticationService.ɵfac, providedIn: 'root' });
/*@__PURE__*/ (function () { i0.ɵsetClassMetadata(UserAuthenticationService, [{
        type: Injectable,
        args: [{ providedIn: 'root' }]
    }], function () { return [{ type: i1.LoggingService }, { type: i2.HttpClient }, { type: i3.AuthenticationStore }, { type: i4.UserAuthenticationQuery }, { type: i5.AppSettingsService }, { type: i6.Router }]; }, null); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXNlckF1dGhlbnRpY2F0aW9uLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4vLi4vcHJvamVjdHMvbmdzY2FmZm9sZGluZy9jb3JlL3NyYy8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy91c2VyQXV0aGVudGljYXRpb24vdXNlckF1dGhlbnRpY2F0aW9uLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNsQyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFekMsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQWMsVUFBVSxFQUFFLFdBQVcsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBSzNFLE9BQU8sRUFBRSxTQUFTLEVBQUUsV0FBVyxFQUFjLE1BQU0sdUJBQXVCLENBQUM7QUFJM0UsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFFdEQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGlCQUFpQixDQUFDOzs7Ozs7OztBQUs5QyxNQUFNLE9BQU8seUJBQXlCO0lBS2xDLFlBQ1ksTUFBc0IsRUFDdEIsSUFBZ0IsRUFDaEIsU0FBOEIsRUFDOUIsU0FBa0MsRUFDbEMsa0JBQXNDLEVBQ3RDLE1BQWM7UUFMZCxXQUFNLEdBQU4sTUFBTSxDQUFnQjtRQUN0QixTQUFJLEdBQUosSUFBSSxDQUFZO1FBQ2hCLGNBQVMsR0FBVCxTQUFTLENBQXFCO1FBQzlCLGNBQVMsR0FBVCxTQUFTLENBQXlCO1FBQ2xDLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7UUFDdEMsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQVZULG9CQUFlLEdBQUcsWUFBWSxDQUFDO1FBWTVDLE1BQU0sQ0FBQyxJQUFJLENBQUMsd0NBQXdDLENBQUMsQ0FBQztRQUN0RCxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUks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YSxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7SUFDcEYsQ0FBQzs7a0dBckxRLHlCQUF5QjtpRUFBekIseUJBQXlCLFdBQXpCLHlCQUF5QixtQkFEWixNQUFNO2tEQUNuQix5QkFBeUI7Y0FEckMsVUFBVTtlQUFDLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgdGltZW91dCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuXHJcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgSHR0cENsaWVudCwgSHR0cFBhcmFtcywgSHR0cEhlYWRlcnMgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XHJcblxyXG5pbXBvcnQgeyBBcHBTZXR0aW5nc1NlcnZpY2UgfSBmcm9tICcuLi9hcHBTZXR0aW5ncy9hcHBTZXR0aW5ncy5zZXJ2aWNlJztcclxuaW1wb3J0IHsgTG9nZ2luZ1NlcnZpY2UgfSBmcm9tICcuLi9sb2dnaW5nL2xvZ2dpbmcuc2VydmljZSc7XHJcblxyXG5pbXBvcnQgeyBCYXNpY1VzZXIsIEFwcFNldHRpbmdzLCBCYXNlRW50aXR5IH0gZnJvbSAnQG5nc2NhZmZvbGRpbmcvbW9kZWxzJztcclxuXHJcbmltcG9ydCB7IEF1dGhlbnRpY2F0aW9uU3RvcmUgfSBmcm9tICcuL3VzZXJBdXRoZW50aWNhdGlvbi5zdG9yZSc7XHJcblxyXG5pbXBvcnQgeyBKd3RIZWxwZXJTZXJ2aWNlIH0gZnJvbSAnQGF1dGgwL2FuZ3VsYXItand0JztcclxuaW1wb3J0IHsgVXNlckF1dGhlbnRpY2F0aW9uQmFzZSB9IGZyb20gJy4vVXNlckF1dGhlbnRpY2F0aW9uQmFzZSc7XHJcbmltcG9ydCB7IHJlc2V0U3RvcmVzIH0gZnJvbSAnQGRhdG9yYW1hL2FraXRhJztcclxuaW1wb3J0IHsgVXNlckF1dGhlbnRpY2F0aW9uUXVlcnkgfSBmcm9tICcuL3VzZXJBdXRoZW50aWNhdGlvbi5xdWVyeSc7XHJcbmltcG9ydCB7IFJvdXRlciB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XHJcblxyXG5ASW5qZWN0YWJsZSh7IHByb3ZpZGVkSW46ICdyb290JyB9KVxyXG5leHBvcnQgY2xhc3MgVXNlckF1dGhlbnRpY2F0aW9uU2VydmljZSBpbXBsZW1lbnRzIFVzZXJBdXRoZW50aWNhdGlvbkJhc2Uge1xyXG4gICAgcHJpdmF0ZSByZWFkb25seSB0b2tlblN0b3JhZ2VLZXkgPSAnVVNFUl9UT0tFTic7XHJcblxyXG4gICAgcHJpdmF0ZSBqd3RIZWxwZXI6IEp3dEhlbHBlclNlcnZpY2U7XHJcblxyXG4gICAgY29uc3RydWN0b3IoXHJcbiAgICAgICAgcHJpdmF0ZSBsb2dnZXI6IExvZ2dpbmdTZXJ2aWNlLFxyXG4gICAgICAgIHByaXZhdGUgaHR0cDogSHR0cENsaWVudCxcclxuICAgICAgICBwcml2YXRlIGF1dGhTdG9yZTogQXV0aGVudGljYXRpb25TdG9yZSxcclxuICAgICAgICBwcml2YXRlIGF1dGhRdWVyeTogVXNlckF1dGhlbnRpY2F0aW9uUXVlcnksXHJcbiAgICAgICAgcHJpdmF0ZSBhcHBTZXR0aW5nc1NlcnZpY2U6IEFwcFNldHRpbmdzU2VydmljZSxcclxuICAgICAgICBwcml2YXRlIHJvdXRlcjogUm91dGVyXHJcbiAgICApIHtcclxuICAgICAgICBsb2dnZXIuaW5mbygnVXNlckF1dGhvcmlzYXRpb25TZXJ2aWNlIC0gQ29uc3RydWN0b3InKTtcclxuICAgICAgICB0aGlzLmp3dEhlbHBlciA9IG5ldyBKd3RIZWxwZXJTZXJ2aWNlKHt9KTtcclxuICAgICAgICB0aGlzLmxvYWRVc2VyVG9rZW5Gcm9tU3RvcmFnZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIGZpbHRlckl0ZW1zQnlSb2xlKGF1dGhJdGVtczogQmFzZUVudGl0eVtdKTogQXJyYXk8QmFzZUVudGl0eT4ge1xyXG4gICAgICAgIGNvbnN0IHJldHVybkl0ZW1zOiBCYXNlRW50aXR5W10gPSBbXTtcclxuXHJcbiAgICAgICAgaWYgKGF1dGhJdGVtcykge1xyXG4gICAgICAgICAgICBhdXRoSXRlbXMuZm9yRWFjaChhdXRoSXRlbSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5jaGVja0J5Um9sZXMoYXV0aEl0ZW0pKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuSXRlbXMucHVzaChhdXRoSXRlbSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHJldHVybkl0ZW1zO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIENoZWNrIGlmIHVzZXIgcGFzc2VzIG11c3RlclxyXG4gICAgY2hlY2tCeVJvbGVzKGF1dGhJdGVtOiBCYXNlRW50aXR5KTogYm9vbGVhbiB7XHJcbiAgICAgICAgLy8gTm8gcm9sZXMgPSBhbHdheXMgb2theVxyXG4gICAgICAgIGlmICghYXV0aEl0ZW0ucm9sZXMpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQgaXNBbGxvd2VkID0gZmFsc2U7XHJcbiAgICAgICAgY29uc3QgdXNlciA9IHRoaXMuYXV0aFF1ZXJ5LmdldFVzZXIoKTtcclxuXHJcbiAgICAgICAgaWYgKHVzZXIucm9sZSkge1xyXG4gICAgICAgICAgICB1c2VyLnJvbGUuZm9yRWFjaChyb2xlID0+IHtcclxuICAgICAgICAgICAgICAgIGF1dGhJdGVtLnJvbGVzLmZvckVhY2goYXV0aFJvbGUgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChyb2xlID09PSBhdXRoUm9sZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpc0FsbG93ZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGlzQWxsb3dlZDtcclxuICAgIH1cclxuXHJcbiAgICBjb21wbGV0ZUF1dGhlbnRpY2F0aW9uKCkge31cclxuICAgIGlzQXV0aGVudGljYXRlZCgpOiBib29sZWFuIHtcclxuICAgICAgICBjb25zdCB0b2tlbiA9IHRoaXMuZ2V0VG9rZW4oKTtcclxuICAgICAgICBjb25zdCB0b2tlbkRldGFpbHMgPSB0aGlzLmp3dEhlbHBlci5kZWNvZGVUb2tlbih0b2tlbik7XHJcblxyXG4gICAgICAgIHJldHVybiB0b2tlbkRldGFpbHMgJiYgIXRoaXMuand0SGVscGVyLmlzVG9rZW5FeHBpcmVkKHRva2VuKTtcclxuICAgIH1cclxuICAgIGF1dGhvcml6YXRpb25IZWFkZXJWYWx1ZSgpIHt9XHJcbiAgICBuYW1lKCk6IHN0cmluZyB7XHJcbiAgICAgICAgcmV0dXJuICdIZWxsbyBXb3JsZCc7XHJcbiAgICB9XHJcblxyXG4gICAgZm9yY2VMb2dvbihyZXR1cm5Vcmw6IHN0cmluZykge1xyXG4gICAgICAgIHRoaXMubG9nb2ZmKCk7XHJcbiAgICAgICAgdGhpcy5yb3V0ZXIubmF2aWdhdGUoWydsb2dpbiddLCB7IHF1ZXJ5UGFyYW1zOiB7IHJldHVyblVybDogcmV0dXJuVXJsIH0gfSk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0VG9rZW4oKTogc3RyaW5nIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5hdXRoUXVlcnkuZ2V0VmFsdWUoKS50b2tlbjtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGxvYWRVc2VyVG9rZW5Gcm9tU3RvcmFnZSgpIHtcclxuICAgICAgICBjb25zdCBzYXZlZFRva2VuID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0odGhpcy50b2tlblN0b3JhZ2VLZXkpOyAvLyBMb2FkZWQgZnJvbSBTYXZlZCBTdG9yYWdlXHJcbiAgICAgICAgaWYgKHNhdmVkVG9rZW4gIT09IG51bGwpIHtcclxuICAgICAgICAgICAgLy8gTmV3IEF1dGhVc2VyIEJhc2VkIG9uIFRva2VuXHJcbiAgICAgICAgICAgIGlmICghdGhpcy5qd3RIZWxwZXIuaXNUb2tlbkV4cGlyZWQoc2F2ZWRUb2tlbikpIHtcclxuICAgICAgICAgICAgICAgIC8vIElmIGFsbCBHb29kXHJcbiAgICAgICAgICAgICAgICB0aGlzLmxvZ2dlci5pbmZvKCdUb2tlbiBmcm9tIFN0b3JhZ2UgLSBUb2tlbiBMb2FkZWQgYW5kIG5vdCBFeHBpcmVkJyk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNldFRva2VuKHNhdmVkVG9rZW4pO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgLy8gRXhwaXJlZCBUb2tlblxyXG4gICAgICAgICAgICAgICAgdGhpcy5sb2dnZXIuaW5mbygnVG9rZW4gZnJvbSBTdG9yYWdlIC0gVG9rZW4gRXhwaXJlZCAtIE5vdCB1c2luZycpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgLy8gTm8gdG9rZW5cclxuICAgICAgICAgICAgdGhpcy5sb2dnZXIuaW5mbygnVG9rZW4gZnJvbSBTdG9yYWdlIC0gTm8gVG9rZW4gQXZhaWxhYmxlJyk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgc2V0VG9rZW4odG9rZW46IGFueSkge1xyXG4gICAgICAgIC8vIE5ldyBBdXRoVXNlciBCYXNlZCBvbiBUb2tlblxyXG4gICAgICAgIGNvbnN0IHRva2VuRGV0YWlscyA9IHRoaXMuand0SGVscGVyLmRlY29kZVRva2VuKHRva2VuKTtcclxuXHJcbiAgICAgICAgY29uc3QgbmV3VXNlciA9IG5ldyBCYXNpY1VzZXIoKTtcclxuXHJcbiAgICAgICAgaWYgKHRva2VuRGV0YWlsc1snZmlyc3ROYW1lJ10gJiYgdG9rZW5EZXRhaWxzWydsYXN0TmFtZSddKSB7XHJcbiAgICAgICAgICAgIG5ld1VzZXIubmFtZSA9IHRva2VuRGV0YWlsc1snZmlyc3ROYW1lJ10gKyAnICcgKyB0b2tlbkRldGFpbHNbJ2xhc3ROYW1lJ107XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodG9rZW5EZXRhaWxzWydzdWInXSkge1xyXG4gICAgICAgICAgICBuZXdVc2VyLnVzZXJJZCA9IHRva2VuRGV0YWlsc1snc3ViJ107XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodG9rZW5EZXRhaWxzWydyb2xlJ10pIHtcclxuICAgICAgICAgICAgbmV3VXNlci5yb2xlID0gdG9rZW5EZXRhaWxzWydyb2xlJ107XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodG9rZW5EZXRhaWxzWydlbWFpbCddKSB7XHJcbiAgICAgICAgICAgIG5ld1VzZXIuZW1haWwgPSB0b2tlbkRldGFpbHNbJ2VtYWlsJ107XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmF1dGhTdG9yZS51cGRhdGUoeyB0b2tlbjogdG9rZW4sIHVzZXJEZXRhaWxzOiBuZXdVc2VyLCBhdXRoZW50aWNhdGVkOiB0cnVlIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBsb2dvbih1c2VyTmFtZTogc3RyaW5nLCBwYXNzd29yZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxudWxsPiB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBPYnNlcnZhYmxlPG51bGw+KG9ic2VydmVyID0+IHtcclxuICAgICAgICAgICAgbGV0IGJvZHkgPSBuZXcgSHR0cFBhcmFtcygpO1xyXG4gICAgICAgICAgICBib2R5ID0gYm9keVxyXG4gICAgICAgICAgICAgICAgLmFwcGVuZCgndXNlcm5hbWUnLCB1c2VyTmFtZSlcclxuICAgICAgICAgICAgICAgIC5hcHBlbmQoJ3Bhc3N3b3JkJywgcGFzc3dvcmQpXHJcbiAgICAgICAgICAgICAgICAuYXBwZW5kKCdncmFudF90eXBlJywgJ3Bhc3N3b3JkJylcclxuICAgICAgICAgICAgICAgIC5hcHBlbmQoJ2NsaWVudF9pZCcsIHRoaXMuYXBwU2V0dGluZ3NTZXJ2aWNlLmdldFZhbHVlKEFwcFNldHRpbmdzLmF1dGhDbGllbnRJZCkpXHJcbiAgICAgICAgICAgICAgICAuYXBwZW5kKCdjbGllbnRfc2VjcmV0JywgdGhpcy5hcHBTZXR0aW5nc1NlcnZpY2UuZ2V0VmFsdWUoQXBwU2V0dGluZ3MuYXV0aENsaWVudFNlY3JldCkpXHJcbiAgICAgICAgICAgICAgICAuYXBwZW5kKCdzY29wZScsIHRoaXMuYXBwU2V0dGluZ3NTZXJ2aWNlLmdldFZhbHVlKEFwcFNldHRpbmdzLmF1dGhTY29wZSkgKyAnIG9mZmxpbmVfYWNjZXNzIG9wZW5pZCcpO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5odHRwXHJcbiAgICAgICAgICAgICAgICAucG9zdChcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcFNldHRpbmdzU2VydmljZS5nZXRWYWx1ZShBcHBTZXR0aW5ncy5hcGlBdXRoKSArIHRoaXMuYXBwU2V0dGluZ3NTZXJ2aWNlLmdldFZhbHVlKEFwcFNldHRpbmdzLmF1dGhUb2tlbkVuZHBvaW50KSxcclxuICAgICAgICAgICAgICAgICAgICBib2R5LFxyXG4gICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaGVhZGVyczogbmV3IEh0dHBIZWFkZXJzKCkuc2V0KCdDb250ZW50LVR5cGUnLCAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJylcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICApXHJcbiAgICAgICAgICAgICAgICAucGlwZSh0aW1lb3V0KDMwMDAwKSlcclxuICAgICAgICAgICAgICAgIC5zdWJzY3JpYmUoXHJcbiAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2UgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBjaGVrIGlmIHVzZXIgaXMgaXMgaW4gJ3VzZXInIHJvbGVcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdG9rZW5EZXRhaWxzID0gdGhpcy5qd3RIZWxwZXIuZGVjb2RlVG9rZW4ocmVzcG9uc2VbJ2FjY2Vzc190b2tlbiddKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVxdWlyZWRSb2xlID0gdGhpcy5hcHBTZXR0aW5nc1NlcnZpY2UuZ2V0VmFsdWUoQXBwU2V0dGluZ3MuYXV0aFJlcXVpcmVkUm9sZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0b2tlbkRldGFpbHNbJ3JvbGUnXSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlcXVpcmVkUm9sZSAmJiAhdG9rZW5EZXRhaWxzWydyb2xlJ10uaW5jbHVkZXMocmVxdWlyZWRSb2xlKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9ic2VydmVyLmVycm9yKCdVbmF1dGhvcmlzZWQnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNhdmUgVG9rZW4gaW4gU3RvcmFnZSBpZiBuZWVkZWRcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuYXBwU2V0dGluZ3NTZXJ2aWNlLmdldFZhbHVlKEFwcFNldHRpbmdzLmF1dGhTYXZlaW5Mb2NhbFN0b3JhZ2UpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSh0aGlzLnRva2VuU3RvcmFnZUtleSwgcmVzcG9uc2VbJ2FjY2Vzc190b2tlbiddKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gTG9hZCBvdXIgZGV0YWlscyBmcm9tIHRoaXMgdG9rZW5cclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRUb2tlbihyZXNwb25zZVsnYWNjZXNzX3Rva2VuJ10pO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3BvbnNlWydyZWZyZXNoX3Rva2VuJ10pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoaXMucmVmcmVzaFRva2VuID0gcmVzcG9uc2VbJ3JlZnJlc2hfdG9rZW4nXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgb2JzZXJ2ZXIubmV4dChudWxsKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgb2JzZXJ2ZXIuY29tcGxldGUoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgZXJyID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgb2JzZXJ2ZXIuZXJyb3IoZXJyKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBsb2dvZmYoKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKHRoaXMuYXBwU2V0dGluZ3NTZXJ2aWNlLmdldFZhbHVlKEFwcFNldHRpbmdzLmF1dGhTYXZlaW5Mb2NhbFN0b3JhZ2UpKSB7XHJcbiAgICAgICAgICAgIC8vIFJlbW92ZSB0b2tlbiBmcm9tIExvY2FsIFN0b3JhZ2VcclxuICAgICAgICAgICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0odGhpcy50b2tlblN0b3JhZ2VLZXkpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gQ2xlYXIgQWtpdGEgU3RvcmVzXHJcbiAgICAgICAgcmVzZXRTdG9yZXMoeyBleGNsdWRlOiBbJ2FwcFNldHRpbmdzJ10gfSk7XHJcblxyXG4gICAgICAgIHRoaXMuYXV0aFN0b3JlLnVwZGF0ZSh7IHRva2VuOiBudWxsLCB1c2VyRGV0YWlsczogbnVsbCwgYXV0aGVudGljYXRlZDogZmFsc2UgfSk7XHJcbiAgICB9XHJcbn1cclxuIl19