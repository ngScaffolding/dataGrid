import { __awaiter } from "tslib";
import { Injectable } from '@angular/core';
import { UserManager } from 'oidc-client';
import { AppSettings, BasicUser } from '@ngscaffolding/models';
import { JwtHelperService } from '@auth0/angular-jwt';
import * as i0 from "@angular/core";
import * as i1 from "./userAuthentication.store";
import * as i2 from "./userAuthentication.query";
import * as i3 from "../appSettings/appSettings.query";
export class OAuthService {
    constructor(authStore, authQuery, appSettingsQuery) {
        this.authStore = authStore;
        this.authQuery = authQuery;
        this.appSettingsQuery = appSettingsQuery;
        this.jwtHelper = new JwtHelperService({});
        appSettingsQuery
            .selectEntity(AppSettings.authOAuthSettings)
            .subscribe((settings) => {
            this.manager = new UserManager(settings.value);
            this.manager.getUser().then((user) => {
                if (user) {
                    this.user = user;
                    this.setToken(this.user.access_token);
                }
            });
        });
    }
    filterItemsByRole(authItems) {
        const returnItems = [];
        if (authItems) {
            authItems.forEach((authItem) => {
                if (this.checkByRoles(authItem)) {
                    returnItems.push(authItem);
                }
            });
        }
        return returnItems;
    }
    // Check if user passes muster
    checkByRoles(authItem) {
        // No roles = always okay
        if (!authItem.roles) {
            return true;
        }
        let isAllowed = false;
        const user = this.authQuery.getUser();
        if (user.role) {
            user.role.forEach((role) => {
                authItem.roles.forEach((authRole) => {
                    if (role === authRole) {
                        isAllowed = true;
                    }
                });
            });
        }
        return isAllowed;
    }
    getToken() {
        return this.user.access_token;
    }
    forceLogon() {
        this.logon();
    }
    logon(userName = '', password = '') {
        return this.manager.signinRedirect();
    }
    logoff() {
        return __awaiter(this, void 0, void 0, function* () {
            yield this.manager.signoutRedirect();
        });
    }
    completeAuthentication() {
        return __awaiter(this, void 0, void 0, function* () {
            this.user = yield this.manager.signinRedirectCallback();
            this.setToken(this.user.access_token);
        });
    }
    isAuthenticated() {
        this.manager.getUser().then((user) => {
            this.user = user;
        });
        return this.user != null && !this.user.expired;
    }
    authorizationHeaderValue() {
        return `${this.user.token_type} ${this.user.access_token}`;
    }
    name() {
        return this.user != null ? this.user.profile.name : '';
    }
    setToken(token) {
        // New AuthUser Based on Token
        const tokenDetails = this.jwtHelper.decodeToken(token);
        const newUser = new BasicUser();
        if (tokenDetails['name']) {
            newUser.name = tokenDetails['name'];
        }
        else if (tokenDetails['firstName'] && tokenDetails['lastName']) {
            newUser.name = tokenDetails['firstName'] + ' ' + tokenDetails['lastName'];
        }
        if (tokenDetails['role']) {
            newUser.role = tokenDetails['role'];
        }
        if (tokenDetails['email']) {
            newUser.userId = tokenDetails['email'];
            newUser.email = tokenDetails['email'];
        }
        this.authStore.update({
            token: token,
            userDetails: newUser,
            authenticated: true,
        });
    }
}
OAuthService.ɵfac = function OAuthService_Factory(t) { return new (t || OAuthService)(i0.ɵɵinject(i1.AuthenticationStore), i0.ɵɵinject(i2.UserAuthenticationQuery), i0.ɵɵinject(i3.AppSettingsQuery)); };
OAuthService.ɵprov = i0.ɵɵdefineInjectable({ token: OAuthService, factory: OAuthService.ɵfac, providedIn: 'root' });
/*@__PURE__*/ (function () { i0.ɵsetClassMetadata(OAuthService, [{
        type: Injectable,
        args: [{
                providedIn: 'root',
            }]
    }], function () { return [{ type: i1.AuthenticationStore }, { type: i2.UserAuthenticationQuery }, { type: i3.AppSettingsQuery }]; }, null); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXNlckF1dGhlbnRpY2F0aW9uLm9hdXRoLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4vLi4vcHJvamVjdHMvbmdzY2FmZm9sZGluZy9jb3JlL3NyYy8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy91c2VyQXV0aGVudGljYXRpb24vdXNlckF1dGhlbnRpY2F0aW9uLm9hdXRoLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLFdBQVcsRUFBNkIsTUFBTSxhQUFhLENBQUM7QUFFckUsT0FBTyxFQUFFLFdBQVcsRUFBYyxTQUFTLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUUzRSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQzs7Ozs7QUFPdEQsTUFBTSxPQUFPLFlBQVk7SUFLdkIsWUFDVSxTQUE4QixFQUM5QixTQUFrQyxFQUNsQyxnQkFBa0M7UUFGbEMsY0FBUyxHQUFULFNBQVMsQ0FBcUI7UUFDOUIsY0FBUyxHQUFULFNBQVMsQ0FBeUI7UUFDbEMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUUxQyxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksZ0JBQWdCLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDMUMsZ0JBQWdCO2FBQ2IsWUFBWSxDQUFDLFdBQVcsQ0FBQyxpQkFBaUIsQ0FBQzthQUMzQyxTQUFTLENBQUMsQ0FBQyxRQUFRLEVBQUUsRUFBRTtZQUN0QixJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksV0FBVyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUMvQyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFO2dCQUNuQyxJQUFJLElBQUksRUFBRTtvQkFDUixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztvQkFD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LDhCQUE4QjtRQUM5QixNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUV2RCxNQUFNLE9BQU8sR0FBRyxJQUFJLFNBQVMsRUFBRSxDQUFDO1FBRWhDLElBQUksWUFBWSxDQUFDLE1BQU0sQ0FBQyxFQUFFO1lBQ3hCLE9BQU8sQ0FBQyxJQUFJLEdBQUcsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1NBQ3JDO2FBQU0sSUFBSSxZQUFZLENBQUMsV0FBVyxDQUFDLElBQUksWUFBWSxDQUFDLFVBQVUsQ0FBQyxFQUFFO1lBQ2hFLE9BQU8sQ0FBQyxJQUFJLEdBQUcsWUFBWSxDQUFDLFdBQVcsQ0FBQyxHQUFHLEdBQUcsR0FBRyxZQUFZLENBQUMsVUFBVSxDQUFDLENBQUM7U0FDM0U7UUFFRCxJQUFJLFlBQVksQ0FBQyxNQUFNLENBQUMsRUFBRTtZQUN4QixPQUFPLENBQUMsSUFBSSxHQUFHLFlBQVksQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUNyQztRQUVELElBQUksWUFBWSxDQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ3pCLE9BQU8sQ0FBQyxNQUFNLEdBQUcsWUFBWSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ3ZDLE9BQU8sQ0FBQyxLQUFLLEdBQUcsWUFBWSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1NBQ3ZDO1FBRUQsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUM7WUFDcEIsS0FBSyxFQUFFLEtBQUs7WUFDWixXQUFXLEVBQUUsT0FBTztZQUNwQixhQUFhLEVBQUUsSUFBSTtTQUNwQixDQUFDLENBQUM7SUFDTCxDQUFDOzt3RUFsSFUsWUFBWTtvREFBWixZQUFZLFdBQVosWUFBWSxtQkFGWCxNQUFNO2tEQUVQLFlBQVk7Y0FIeEIsVUFBVTtlQUFDO2dCQUNWLFVBQVUsRUFBRSxNQUFNO2FBQ25CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBVc2VyTWFuYWdlciwgVXNlck1hbmFnZXJTZXR0aW5ncywgVXNlciB9IGZyb20gJ29pZGMtY2xpZW50JztcclxuaW1wb3J0IHsgVXNlckF1dGhlbnRpY2F0aW9uQmFzZSB9IGZyb20gJy4vVXNlckF1dGhlbnRpY2F0aW9uQmFzZSc7XHJcbmltcG9ydCB7IEFwcFNldHRpbmdzLCBCYXNlRW50aXR5LCBCYXNpY1VzZXIgfSBmcm9tICdAbmdzY2FmZm9sZGluZy9tb2RlbHMnO1xyXG5pbXBvcnQgeyBBdXRoZW50aWNhdGlvblN0b3JlIH0gZnJvbSAnLi91c2VyQXV0aGVudGljYXRpb24uc3RvcmUnO1xyXG5pbXBvcnQgeyBKd3RIZWxwZXJTZXJ2aWNlIH0gZnJvbSAnQGF1dGgwL2FuZ3VsYXItand0JztcclxuaW1wb3J0IHsgVXNlckF1dGhlbnRpY2F0aW9uUXVlcnkgfSBmcm9tICcuL3VzZXJBdXRoZW50aWNhdGlvbi5xdWVyeSc7XHJcbmltcG9ydCB7IEFwcFNldHRpbmdzUXVlcnkgfSBmcm9tICcuLi9hcHBTZXR0aW5ncy9hcHBTZXR0aW5ncy5xdWVyeSc7XHJcblxyXG5ASW5qZWN0YWJsZSh7XHJcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnLFxyXG59KVxyXG5leHBvcnQgY2xhc3MgT0F1dGhTZXJ2aWNlIGltcGxlbWVudHMgVXNlckF1dGhlbnRpY2F0aW9uQmFzZSB7XHJcbiAgcHJpdmF0ZSBtYW5hZ2VyOiBVc2VyTWFuYWdlcjtcclxuICBwcml2YXRlIHVzZXI6IFVzZXIgfCBudWxsO1xyXG4gIHByaXZhdGUgand0SGVscGVyOiBKd3RIZWxwZXJTZXJ2aWNlO1xyXG5cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgYXV0aFN0b3JlOiBBdXRoZW50aWNhdGlvblN0b3JlLFxyXG4gICAgcHJpdmF0ZSBhdXRoUXVlcnk6IFVzZXJBdXRoZW50aWNhdGlvblF1ZXJ5LFxyXG4gICAgcHJpdmF0ZSBhcHBTZXR0aW5nc1F1ZXJ5OiBBcHBTZXR0aW5nc1F1ZXJ5XHJcbiAgKSB7XHJcbiAgICB0aGlzLmp3dEhlbHBlciA9IG5ldyBKd3RIZWxwZXJTZXJ2aWNlKHt9KTtcclxuICAgIGFwcFNldHRpbmdzUXVlcnlcclxuICAgICAgLnNlbGVjdEVudGl0eShBcHBTZXR0aW5ncy5hdXRoT0F1dGhTZXR0aW5ncylcclxuICAgICAgLnN1YnNjcmliZSgoc2V0dGluZ3MpID0+IHtcclxuICAgICAgICB0aGlzLm1hbmFnZXIgPSBuZXcgVXNlck1hbmFnZXIoc2V0dGluZ3MudmFsdWUpO1xyXG4gICAgICAgIHRoaXMubWFuYWdlci5nZXRVc2VyKCkudGhlbigodXNlcikgPT4ge1xyXG4gICAgICAgICAgaWYgKHVzZXIpIHtcclxuICAgICAgICAgICAgdGhpcy51c2VyID0gdXNlcjtcclxuICAgICAgICAgICAgdGhpcy5zZXRUb2tlbih0aGlzLnVzZXIuYWNjZXNzX3Rva2VuKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgfSk7XHJcbiAgfVxyXG4gIGZpbHRlckl0ZW1zQnlSb2xlKGF1dGhJdGVtczogQmFzZUVudGl0eVtdKTogQXJyYXk8QmFzZUVudGl0eT4ge1xyXG4gICAgY29uc3QgcmV0dXJuSXRlbXM6IEJhc2VFbnRpdHlbXSA9IFtdO1xyXG5cclxuICAgIGlmIChhdXRoSXRlbXMpIHtcclxuICAgICAgYXV0aEl0ZW1zLmZvckVhY2goKGF1dGhJdGVtKSA9PiB7XHJcbiAgICAgICAgaWYgKHRoaXMuY2hlY2tCeVJvbGVzKGF1dGhJdGVtKSkge1xyXG4gICAgICAgICAgcmV0dXJuSXRlbXMucHVzaChhdXRoSXRlbSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gcmV0dXJuSXRlbXM7XHJcbiAgfVxyXG5cclxuICAvLyBDaGVjayBpZiB1c2VyIHBhc3NlcyBtdXN0ZXJcclxuICBjaGVja0J5Um9sZXMoYXV0aEl0ZW06IEJhc2VFbnRpdHkpOiBib29sZWFuIHtcclxuICAgIC8vIE5vIHJvbGVzID0gYWx3YXlzIG9rYXlcclxuICAgIGlmICghYXV0aEl0ZW0ucm9sZXMpIHtcclxuICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IGlzQWxsb3dlZCA9IGZhbHNlO1xyXG4gICAgY29uc3QgdXNlciA9IHRoaXMuYXV0aFF1ZXJ5LmdldFVzZXIoKTtcclxuXHJcbiAgICBpZiAodXNlci5yb2xlKSB7XHJcbiAgICAgIHVzZXIucm9sZS5mb3JFYWNoKChyb2xlKSA9PiB7XHJcbiAgICAgICAgYXV0aEl0ZW0ucm9sZXMuZm9yRWFjaCgoYXV0aFJvbGUpID0+IHtcclxuICAgICAgICAgIGlmIChyb2xlID09PSBhdXRoUm9sZSkge1xyXG4gICAgICAgICAgICBpc0FsbG93ZWQgPSB0cnVlO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICAgIHJldHVybiBpc0FsbG93ZWQ7XHJcbiAgfVxyXG5cclxuICBnZXRUb2tlbigpOiBzdHJpbmcge1xyXG4gICAgcmV0dXJuIHRoaXMudXNlci5hY2Nlc3NfdG9rZW47XHJcbiAgfVxyXG4gIGZvcmNlTG9nb24oKSB7XHJcbiAgICB0aGlzLmxvZ29uKCk7XHJcbiAgfVxyXG4gIGxvZ29uKHVzZXJOYW1lID0gJycsIHBhc3N3b3JkID0gJycpIHtcclxuICAgIHJldHVybiB0aGlzLm1hbmFnZXIuc2lnbmluUmVkaXJlY3QoKTtcclxuICB9XHJcbiAgYXN5bmMgbG9nb2ZmKCkge1xyXG4gICAgYXdhaXQgdGhpcy5tYW5hZ2VyLnNpZ25vdXRSZWRpcmVjdCgpO1xyXG4gIH1cclxuICBhc3luYyBjb21wbGV0ZUF1dGhlbnRpY2F0aW9uKCkge1xyXG4gICAgdGhpcy51c2VyID0gYXdhaXQgdGhpcy5tYW5hZ2VyLnNpZ25pblJlZGlyZWN0Q2FsbGJhY2soKTtcclxuICAgIHRoaXMuc2V0VG9rZW4odGhpcy51c2VyLmFjY2Vzc190b2tlbik7XHJcbiAgfVxyXG4gIGlzQXV0aGVudGljYXRlZCgpOiBib29sZWFuIHtcclxuICAgIHRoaXMubWFuYWdlci5nZXRVc2VyKCkudGhlbigodXNlcikgPT4ge1xyXG4gICAgICB0aGlzLnVzZXIgPSB1c2VyO1xyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gdGhpcy51c2VyICE9IG51bGwgJiYgIXRoaXMudXNlci5leHBpcmVkO1xyXG4gIH1cclxuICBhdXRob3JpemF0aW9uSGVhZGVyVmFsdWUoKSB7XHJcbiAgICByZXR1cm4gYCR7dGhpcy51c2VyLnRva2VuX3R5cGV9ICR7dGhpcy51c2VyLmFjY2Vzc190b2tlbn1gO1xyXG4gIH1cclxuICBuYW1lKCk6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gdGhpcy51c2VyICE9IG51bGwgPyB0aGlzLnVzZXIucHJvZmlsZS5uYW1lIDogJyc7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHNldFRva2VuKHRva2VuOiBhbnkpIHtcclxuICAgIC8vIE5ldyBBdXRoVXNlciBCYXNlZCBvbiBUb2tlblxyXG4gICAgY29uc3QgdG9rZW5EZXRhaWxzID0gdGhpcy5qd3RIZWxwZXIuZGVjb2RlVG9rZW4odG9rZW4pO1xyXG5cclxuICAgIGNvbnN0IG5ld1VzZXIgPSBuZXcgQmFzaWNVc2VyKCk7XHJcblxyXG4gICAgaWYgKHRva2VuRGV0YWlsc1snbmFtZSddKSB7XHJcbiAgICAgIG5ld1VzZXIubmFtZSA9IHRva2VuRGV0YWlsc1snbmFtZSddO1xyXG4gICAgfSBlbHNlIGlmICh0b2tlbkRldGFpbHNbJ2ZpcnN0TmFtZSddICYmIHRva2VuRGV0YWlsc1snbGFzdE5hbWUnXSkge1xyXG4gICAgICBuZXdVc2VyLm5hbWUgPSB0b2tlbkRldGFpbHNbJ2ZpcnN0TmFtZSddICsgJyAnICsgdG9rZW5EZXRhaWxzWydsYXN0TmFtZSddO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICh0b2tlbkRldGFpbHNbJ3JvbGUnXSkge1xyXG4gICAgICBuZXdVc2VyLnJvbGUgPSB0b2tlbkRldGFpbHNbJ3JvbGUnXTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAodG9rZW5EZXRhaWxzWydlbWFpbCddKSB7XHJcbiAgICAgIG5ld1VzZXIudXNlcklkID0gdG9rZW5EZXRhaWxzWydlbWFpbCddO1xyXG4gICAgICBuZXdVc2VyLmVtYWlsID0gdG9rZW5EZXRhaWxzWydlbWFpbCddO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuYXV0aFN0b3JlLnVwZGF0ZSh7XHJcbiAgICAgIHRva2VuOiB0b2tlbixcclxuICAgICAgdXNlckRldGFpbHM6IG5ld1VzZXIsXHJcbiAgICAgIGF1dGhlbnRpY2F0ZWQ6IHRydWUsXHJcbiAgICB9KTtcclxuICB9XHJcbn1cclxuIl19