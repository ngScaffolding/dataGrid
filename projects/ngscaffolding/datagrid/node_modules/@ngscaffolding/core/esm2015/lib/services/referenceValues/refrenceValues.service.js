import { Observable } from 'rxjs';
import { Injectable } from '@angular/core';
import { AppSettings } from '@ngscaffolding/models';
import { timeout, retry } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
import * as i2 from "../appSettings/appSettings.service";
import * as i3 from "./referenceValues.query";
import * as i4 from "./referenceValues.store";
import * as i5 from "../logging/logging.service";
export class ReferenceValuesService {
    constructor(http, appSettingsService, refValuesQuery, refValuesStore, logger) {
        this.http = http;
        this.appSettingsService = appSettingsService;
        this.refValuesQuery = refValuesQuery;
        this.refValuesStore = refValuesStore;
        this.logger = logger;
        this.className = 'ReferenceValuesService';
        this.requestsInFlight = new Map();
    }
    //
    // Get a single string value from References
    //
    getValue(name, group) {
        return new Observable(observer => {
            this.getReferenceValue(name, group).subscribe(reference => {
                if (reference) {
                    observer.next(reference.value);
                }
                else {
                    observer.next(null);
                }
                observer.complete();
            });
        });
    }
    // Clear all Reference values with this name as root of key
    clearReferenceValue(clearNames) {
        let namesArray;
        if (Array.isArray(clearNames)) {
            namesArray = clearNames;
        }
        else {
            namesArray = [clearNames];
        }
        for (const loopName of namesArray) {
            const list = this.refValuesQuery.getAll({ filterBy: entity => entity.name.startsWith(loopName) });
            for (const refValue of list) {
                this.refValuesStore.remove(refValue.compositeKey);
            }
        }
    }
    setReferenceValue(referenceValue) {
        referenceValue.compositeKey = this.getKey(referenceValue.name, '');
        this.refValuesStore.upsert(this.getKey(referenceValue.name, ''), referenceValue);
    }
    isExpired(refVal) {
        const cacheSeconds = refVal.cacheSeconds || 31556952; // Default to a year
        const nowDate = new Date();
        const expires = new Date(refVal.whenStored);
        expires.setSeconds(expires.getSeconds() + cacheSeconds);
        return nowDate > expires;
    }
    //
    // Get a complex ReferenceValue (May include multiple values)
    //
    getReferenceValue(name, seed = '', childDepth = 0) {
        if (this.refValuesQuery.hasEntity(this.getKey(name, seed))) {
            const cacheValue = this.refValuesQuery.getEntity(this.getKey(name, seed));
            if (this.isExpired(cacheValue)) {
                // Expired cache value. Go get a new one
                return this.downloadRefValue(name, seed);
            }
            // If we get one from Cache, thats handy to use
            this.logger.info(`Reference Values From Cache ${name}::${seed}`);
            return new Observable(observer => {
                observer.next(this.refValuesQuery.getEntity(this.getKey(name, seed)));
                observer.complete();
            });
        }
        else if (childDepth > 0) {
            const refValue = this.refValuesQuery.getEntity(this.getKey(name, ''));
            if (refValue) {
                const parentRef = refValue.referenceValueItems.find(parent => parent.value === seed);
                if (parentRef) {
                    const clone = Object.assign({}, refValue);
                    clone.referenceValueItems = parentRef.referenceValueItems;
                    return new Observable(observer => {
                        observer.next(clone);
                        observer.complete();
                    });
                }
            }
        }
        else {
            return this.downloadRefValue(name, seed);
        }
    }
    downloadRefValue(name, seed) {
        // Nothing in the Cache
        if (this.requestsInFlight.has(this.getKey(name, seed))) {
            // We have already asked for this, return our existing Observable
            return this.requestsInFlight.get(this.getKey(name, seed));
        }
        else {
            const wrapper = new Observable(observer => {
                // Call HTTP Here
                this.logger.info(`Reference Values From HTTP ${name}::${seed}`);
                const httpRequest = this.http
                    .get(`${this.appSettingsService.getValue(AppSettings.apiHome)}/api/v1/referencevalues?name=${name}&seed=${seed}`)
                    .pipe(timeout(20000), retry(3));
                httpRequest.subscribe(value => {
                    value.compositeKey = this.getKey(name, seed);
                    value.whenStored = new Date();
                    this.refValuesStore.upsert(this.getKey(name, seed), value);
                    this.requestsInFlight.delete(this.getKey(name, seed));
                    observer.next(value);
                    observer.complete();
                }, err => {
                    // Error here. If we have a valid value, respond with that
                    if (this.refValuesQuery.hasEntity(this.getKey(name, seed))) {
                        this.logger.info(`Reference Values From HTTP Failed using last Cache ${name}::${seed}`);
                        observer.next(this.refValuesQuery.getEntity(this.getKey(name, seed)));
                        observer.complete();
                    }
                    else {
                        observer.error(err);
                    }
                });
            });
            this.requestsInFlight.set(this.getKey(name, seed), wrapper);
            return wrapper;
        }
    }
    getKey(name, seed) {
        return `${name}::${seed}`;
    }
}
ReferenceValuesService.ɵfac = function ReferenceValuesService_Factory(t) { return new (t || ReferenceValuesService)(i0.ɵɵinject(i1.HttpClient), i0.ɵɵinject(i2.AppSettingsService), i0.ɵɵinject(i3.ReferenceValuesQuery), i0.ɵɵinject(i4.ReferenceValuesStore), i0.ɵɵinject(i5.LoggingService)); };
ReferenceValuesService.ɵprov = i0.ɵɵdefineInjectable({ token: ReferenceValuesService, factory: ReferenceValuesService.ɵfac, providedIn: 'root' });
/*@__PURE__*/ (function () { i0.ɵsetClassMetadata(ReferenceValuesService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: i1.HttpClient }, { type: i2.AppSettingsService }, { type: i3.ReferenceValuesQuery }, { type: i4.ReferenceValuesStore }, { type: i5.LoggingService }]; }, null); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVmcmVuY2VWYWx1ZXMuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3NjYWZmb2xkaW5nL2NvcmUvc3JjLyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2VzL3JlZmVyZW5jZVZhbHVlcy9yZWZyZW5jZVZhbHVlcy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFbEMsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUczQyxPQUFPLEVBQWtCLFdBQVcsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBS3BFLE9BQU8sRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7Ozs7Ozs7QUFLaEQsTUFBTSxPQUFPLHNCQUFzQjtJQUsvQixZQUNZLElBQWdCLEVBQ2hCLGtCQUFzQyxFQUN0QyxjQUFvQyxFQUNwQyxjQUFvQyxFQUNwQyxNQUFzQjtRQUp0QixTQUFJLEdBQUosSUFBSSxDQUFZO1FBQ2hCLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7UUFDdEMsbUJBQWMsR0FBZCxjQUFjLENBQXNCO1FBQ3BDLG1CQUFjLEdBQWQsY0FBYyxDQUFzQjtRQUNwQyxXQUFNLEdBQU4sTUFBTSxDQUFnQjtRQVQxQixjQUFTLEdBQUcsd0JBQXdCLENBQUM7UUFFckMscUJBQWdCLEdBQUcsSUFBSSxHQUFHLEVBQXNDLENBQUM7SUFRdEUsQ0FBQztJQUVKLEVBQUU7SUFDRiw0Q0FBNEM7SUFDNUMsRUFBRTtJQUNGLFFBQVEsQ0FBQyxJQUFZLEVBQUUsS0FBYTtRQUNoQyxPQUFPLElBQUksVUFBVSxDQUFTLFFBQVEsQ0FBQyxFQUFFO1lBQ3JDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxFQUFFO2dCQUN0RCxJQUFJLFNBQVMsRUFBRTtvQkFD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U0FBUyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDLEVBQUU7d0JBQ3hELElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLHNEQUFzRCxJQUFJLEtBQUssSUFBSSxFQUFFLENBQUMsQ0FBQzt3QkFDeEYsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7d0JBQ3RFLFFBQVEsQ0FBQyxRQUFRLEVBQUUsQ0FBQztxQkFDdkI7eUJBQU07d0JBQ0gsUUFBUSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztxQkFDdkI7Z0JBQ0wsQ0FBQyxDQUNKLENBQUM7WUFDVixDQUFDLENBQUMsQ0FBQztZQUVILElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsT0FBTyxDQUFDLENBQUM7WUFDNUQsT0FBTyxPQUFPLENBQUM7U0FDbEI7SUFDTCxDQUFDO0lBRU8sTUFBTSxDQUFDLElBQVksRUFBRSxJQUFZO1FBQ3JDLE9BQU8sR0FBRyxJQUFJLEtBQUssSUFBSSxFQUFFLENBQUM7SUFDOUIsQ0FBQzs7NEZBOUlRLHNCQUFzQjs4REFBdEIsc0JBQXNCLFdBQXRCLHNCQUFzQixtQkFGbkIsTUFBTTtrREFFVCxzQkFBc0I7Y0FIbEMsVUFBVTtlQUFDO2dCQUNSLFVBQVUsRUFBRSxNQUFNO2FBQ3JCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBIdHRwQ2xpZW50IH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xyXG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcblxyXG5pbXBvcnQgeyBBcHBTZXR0aW5nc1NlcnZpY2UgfSBmcm9tICcuLi9hcHBTZXR0aW5ncy9hcHBTZXR0aW5ncy5zZXJ2aWNlJztcclxuaW1wb3J0IHsgUmVmZXJlbmNlVmFsdWUsIEFwcFNldHRpbmdzIH0gZnJvbSAnQG5nc2NhZmZvbGRpbmcvbW9kZWxzJztcclxuaW1wb3J0IHsgTG9nZ2luZ1NlcnZpY2UgfSBmcm9tICcuLi9sb2dnaW5nL2xvZ2dpbmcuc2VydmljZSc7XHJcbmltcG9ydCB7IFJlZmVyZW5jZVZhbHVlc1F1ZXJ5IH0gZnJvbSAnLi9yZWZlcmVuY2VWYWx1ZXMucXVlcnknO1xyXG5pbXBvcnQgeyBSZWZlcmVuY2VWYWx1ZXNTdG9yZSB9IGZyb20gJy4vcmVmZXJlbmNlVmFsdWVzLnN0b3JlJztcclxuaW1wb3J0IHsgaXNBcnJheSB9IGZyb20gJ3V0aWwnO1xyXG5pbXBvcnQgeyB0aW1lb3V0LCByZXRyeSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuXHJcbkBJbmplY3RhYmxlKHtcclxuICAgIHByb3ZpZGVkSW46ICdyb290J1xyXG59KVxyXG5leHBvcnQgY2xhc3MgUmVmZXJlbmNlVmFsdWVzU2VydmljZSB7XHJcbiAgICBwcml2YXRlIGNsYXNzTmFtZSA9ICdSZWZlcmVuY2VWYWx1ZXNTZXJ2aWNlJztcclxuXHJcbiAgICBwcml2YXRlIHJlcXVlc3RzSW5GbGlnaHQgPSBuZXcgTWFwPHN0cmluZywgT2JzZXJ2YWJsZTxSZWZlcmVuY2VWYWx1ZT4+KCk7XHJcblxyXG4gICAgY29uc3RydWN0b3IoXHJcbiAgICAgICAgcHJpdmF0ZSBodHRwOiBIdHRwQ2xpZW50LFxyXG4gICAgICAgIHByaXZhdGUgYXBwU2V0dGluZ3NTZXJ2aWNlOiBBcHBTZXR0aW5nc1NlcnZpY2UsXHJcbiAgICAgICAgcHJpdmF0ZSByZWZWYWx1ZXNRdWVyeTogUmVmZXJlbmNlVmFsdWVzUXVlcnksXHJcbiAgICAgICAgcHJpdmF0ZSByZWZWYWx1ZXNTdG9yZTogUmVmZXJlbmNlVmFsdWVzU3RvcmUsXHJcbiAgICAgICAgcHJpdmF0ZSBsb2dnZXI6IExvZ2dpbmdTZXJ2aWNlXHJcbiAgICApIHt9XHJcblxyXG4gICAgLy9cclxuICAgIC8vIEdldCBhIHNpbmdsZSBzdHJpbmcgdmFsdWUgZnJvbSBSZWZlcmVuY2VzXHJcbiAgICAvL1xyXG4gICAgZ2V0VmFsdWUobmFtZTogc3RyaW5nLCBncm91cDogc3RyaW5nKTogT2JzZXJ2YWJsZTxzdHJpbmc+IHtcclxuICAgICAgICByZXR1cm4gbmV3IE9ic2VydmFibGU8c3RyaW5nPihvYnNlcnZlciA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuZ2V0UmVmZXJlbmNlVmFsdWUobmFtZSwgZ3JvdXApLnN1YnNjcmliZShyZWZlcmVuY2UgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKHJlZmVyZW5jZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIG9ic2VydmVyLm5leHQocmVmZXJlbmNlLnZhbHVlKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgb2JzZXJ2ZXIubmV4dChudWxsKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIENsZWFyIGFsbCBSZWZlcmVuY2UgdmFsdWVzIHdpdGggdGhpcyBuYW1lIGFzIHJvb3Qgb2Yga2V5XHJcbiAgICBjbGVhclJlZmVyZW5jZVZhbHVlKGNsZWFyTmFtZXM6IHN0cmluZyB8IEFycmF5PHN0cmluZz4pIHtcclxuICAgICAgICBsZXQgbmFtZXNBcnJheTogQXJyYXk8c3RyaW5nPjtcclxuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShjbGVhck5hbWVzKSkge1xyXG4gICAgICAgICAgICBuYW1lc0FycmF5ID0gY2xlYXJOYW1lcztcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBuYW1lc0FycmF5ID0gW2NsZWFyTmFtZXNdO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgZm9yIChjb25zdCBsb29wTmFtZSBvZiBuYW1lc0FycmF5KSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGxpc3QgPSB0aGlzLnJlZlZhbHVlc1F1ZXJ5LmdldEFsbCh7IGZpbHRlckJ5OiBlbnRpdHkgPT4gZW50aXR5Lm5hbWUuc3RhcnRzV2l0aChsb29wTmFtZSkgfSk7XHJcblxyXG4gICAgICAgIGZvciAoY29uc3QgcmVmVmFsdWUgb2YgbGlzdCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5yZWZWYWx1ZXNTdG9yZS5yZW1vdmUocmVmVmFsdWUuY29tcG9zaXRlS2V5KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBzZXRSZWZlcmVuY2VWYWx1ZShyZWZlcmVuY2VWYWx1ZTogUmVmZXJlbmNlVmFsdWUpIHtcclxuICAgICAgICByZWZlcmVuY2VWYWx1ZS5jb21wb3NpdGVLZXkgPSB0aGlzLmdldEtleShyZWZlcmVuY2VWYWx1ZS5uYW1lLCAnJyk7XHJcbiAgICAgICAgdGhpcy5yZWZWYWx1ZXNTdG9yZS51cHNlcnQodGhpcy5nZXRLZXkocmVmZXJlbmNlVmFsdWUubmFtZSwgJycpLCByZWZlcmVuY2VWYWx1ZSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBpc0V4cGlyZWQocmVmVmFsOiBSZWZlcmVuY2VWYWx1ZSk6IGJvb2xlYW4ge1xyXG4gICAgICAgIGNvbnN0IGNhY2hlU2Vjb25kcyA9IHJlZlZhbC5jYWNoZVNlY29uZHMgfHwgMzE1NTY5NTI7IC8vIERlZmF1bHQgdG8gYSB5ZWFyXHJcbiAgICAgICAgY29uc3Qgbm93RGF0ZSA9IG5ldyBEYXRlKCk7XHJcbiAgICAgICAgY29uc3QgZXhwaXJlcyA9IG5ldyBEYXRlKHJlZlZhbC53aGVuU3RvcmVkKTtcclxuXHJcbiAgICAgICAgZXhwaXJlcy5zZXRTZWNvbmRzKGV4cGlyZXMuZ2V0U2Vjb25kcygpICsgY2FjaGVTZWNvbmRzKTtcclxuICAgICAgICByZXR1cm4gbm93RGF0ZSA+IGV4cGlyZXM7XHJcbiAgICB9XHJcblxyXG4gICAgLy9cclxuICAgIC8vIEdldCBhIGNvbXBsZXggUmVmZXJlbmNlVmFsdWUgKE1heSBpbmNsdWRlIG11bHRpcGxlIHZhbHVlcylcclxuICAgIC8vXHJcbiAgICBnZXRSZWZlcmVuY2VWYWx1ZShuYW1lOiBzdHJpbmcsIHNlZWQgPSAnJywgY2hpbGREZXB0aCA9IDApOiBPYnNlcnZhYmxlPFJlZmVyZW5jZVZhbHVlPiB7XHJcbiAgICAgICAgaWYgKHRoaXMucmVmVmFsdWVzUXVlcnkuaGFzRW50aXR5KHRoaXMuZ2V0S2V5KG5hbWUsIHNlZWQpKSkge1xyXG4gICAgICAgICAgICBjb25zdCBjYWNoZVZhbHVlID0gdGhpcy5yZWZWYWx1ZXNRdWVyeS5nZXRFbnRpdHkodGhpcy5nZXRLZXkobmFtZSwgc2VlZCkpO1xyXG4gICAgICAgICAgICBpZiAodGhpcy5pc0V4cGlyZWQoY2FjaGVWYWx1ZSkpIHtcclxuICAgICAgICAgICAgICAgIC8vIEV4cGlyZWQgY2FjaGUgdmFsdWUuIEdvIGdldCBhIG5ldyBvbmVcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmRvd25sb2FkUmVmVmFsdWUobmFtZSwgc2VlZCk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIC8vIElmIHdlIGdldCBvbmUgZnJvbSBDYWNoZSwgdGhhdHMgaGFuZHkgdG8gdXNlXHJcbiAgICAgICAgICAgIHRoaXMubG9nZ2VyLmluZm8oYFJlZmVyZW5jZSBWYWx1ZXMgRnJvbSBDYWNoZSAke25hbWV9Ojoke3NlZWR9YCk7XHJcbiAgICAgICAgICAgIHJldHVybiBuZXcgT2JzZXJ2YWJsZTxSZWZlcmVuY2VWYWx1ZT4ob2JzZXJ2ZXIgPT4ge1xyXG4gICAgICAgICAgICAgICAgb2JzZXJ2ZXIubmV4dCh0aGlzLnJlZlZhbHVlc1F1ZXJ5LmdldEVudGl0eSh0aGlzLmdldEtleShuYW1lLCBzZWVkKSkpO1xyXG4gICAgICAgICAgICAgICAgb2JzZXJ2ZXIuY29tcGxldGUoKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSBlbHNlIGlmIChjaGlsZERlcHRoID4gMCkge1xyXG4gICAgICAgICAgICBjb25zdCByZWZWYWx1ZSA9IHRoaXMucmVmVmFsdWVzUXVlcnkuZ2V0RW50aXR5KHRoaXMuZ2V0S2V5KG5hbWUsICcnKSk7XHJcbiAgICAgICAgICAgIGlmIChyZWZWYWx1ZSkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcGFyZW50UmVmID0gcmVmVmFsdWUucmVmZXJlbmNlVmFsdWVJdGVtcy5maW5kKHBhcmVudCA9PiBwYXJlbnQudmFsdWUgPT09IHNlZWQpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHBhcmVudFJlZikge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGNsb25lID0geyAuLi5yZWZWYWx1ZSB9O1xyXG4gICAgICAgICAgICAgICAgICAgIGNsb25lLnJlZmVyZW5jZVZhbHVlSXRlbXMgPSBwYXJlbnRSZWYucmVmZXJlbmNlVmFsdWVJdGVtcztcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBPYnNlcnZhYmxlPFJlZmVyZW5jZVZhbHVlPihvYnNlcnZlciA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG9ic2VydmVyLm5leHQoY2xvbmUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZG93bmxvYWRSZWZWYWx1ZShuYW1lLCBzZWVkKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBkb3dubG9hZFJlZlZhbHVlKG5hbWU6IHN0cmluZywgc2VlZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxSZWZlcmVuY2VWYWx1ZT4ge1xyXG4gICAgICAgIC8vIE5vdGhpbmcgaW4gdGhlIENhY2hlXHJcbiAgICAgICAgaWYgKHRoaXMucmVxdWVzdHNJbkZsaWdodC5oYXModGhpcy5nZXRLZXkobmFtZSwgc2VlZCkpKSB7XHJcbiAgICAgICAgICAgIC8vIFdlIGhhdmUgYWxyZWFkeSBhc2tlZCBmb3IgdGhpcywgcmV0dXJuIG91ciBleGlzdGluZyBPYnNlcnZhYmxlXHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnJlcXVlc3RzSW5GbGlnaHQuZ2V0KHRoaXMuZ2V0S2V5KG5hbWUsIHNlZWQpKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBjb25zdCB3cmFwcGVyID0gbmV3IE9ic2VydmFibGU8UmVmZXJlbmNlVmFsdWU+KG9ic2VydmVyID0+IHtcclxuICAgICAgICAgICAgICAgIC8vIENhbGwgSFRUUCBIZXJlXHJcbiAgICAgICAgICAgICAgICB0aGlzLmxvZ2dlci5pbmZvKGBSZWZlcmVuY2UgVmFsdWVzIEZyb20gSFRUUCAke25hbWV9Ojoke3NlZWR9YCk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBodHRwUmVxdWVzdCA9IHRoaXMuaHR0cFxyXG4gICAgICAgICAgICAgICAgICAgIC5nZXQ8UmVmZXJlbmNlVmFsdWU+KFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBgJHt0aGlzLmFwcFNldHRpbmdzU2VydmljZS5nZXRWYWx1ZShBcHBTZXR0aW5ncy5hcGlIb21lKX0vYXBpL3YxL3JlZmVyZW5jZXZhbHVlcz9uYW1lPSR7bmFtZX0mc2VlZD0ke3NlZWR9YFxyXG4gICAgICAgICAgICAgICAgICAgIClcclxuICAgICAgICAgICAgICAgICAgICAucGlwZSh0aW1lb3V0KDIwMDAwKSwgcmV0cnkoMykpO1xyXG4gICAgICAgICAgICAgICAgaHR0cFJlcXVlc3Quc3Vic2NyaWJlKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZS5jb21wb3NpdGVLZXkgPSB0aGlzLmdldEtleShuYW1lLCBzZWVkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlLndoZW5TdG9yZWQgPSBuZXcgRGF0ZSgpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVmVmFsdWVzU3RvcmUudXBzZXJ0KHRoaXMuZ2V0S2V5KG5hbWUsIHNlZWQpLCB2YWx1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlcXVlc3RzSW5GbGlnaHQuZGVsZXRlKHRoaXMuZ2V0S2V5KG5hbWUsIHNlZWQpKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5uZXh0KHZhbHVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVyciA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBFcnJvciBoZXJlLiBJZiB3ZSBoYXZlIGEgdmFsaWQgdmFsdWUsIHJlc3BvbmQgd2l0aCB0aGF0XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5yZWZWYWx1ZXNRdWVyeS5oYXNFbnRpdHkodGhpcy5nZXRLZXkobmFtZSwgc2VlZCkpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2dnZXIuaW5mbyhgUmVmZXJlbmNlIFZhbHVlcyBGcm9tIEhUVFAgRmFpbGVkIHVzaW5nIGxhc3QgQ2FjaGUgJHtuYW1lfTo6JHtzZWVkfWApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9ic2VydmVyLm5leHQodGhpcy5yZWZWYWx1ZXNRdWVyeS5nZXRFbnRpdHkodGhpcy5nZXRLZXkobmFtZSwgc2VlZCkpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5lcnJvcihlcnIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICB0aGlzLnJlcXVlc3RzSW5GbGlnaHQuc2V0KHRoaXMuZ2V0S2V5KG5hbWUsIHNlZWQpLCB3cmFwcGVyKTtcclxuICAgICAgICAgICAgcmV0dXJuIHdyYXBwZXI7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0S2V5KG5hbWU6IHN0cmluZywgc2VlZDogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgICAgICByZXR1cm4gYCR7bmFtZX06OiR7c2VlZH1gO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==